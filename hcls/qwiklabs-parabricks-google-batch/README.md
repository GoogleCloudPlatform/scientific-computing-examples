# Parabricks on Google Batch

This project demonstrates how to run NVIDIA's Parabricks software on Google Cloud Batch.

## Description

This sample sets up a Google Cloud Storage bucket, populates it with the necessary scripts, and then uses a JSON configuration file to submit a job to Google Cloud Batch. The Batch job runs a container with Parabricks installed, which then downloads sample data and runs a `fq2bam` and `deepvariant` pipeline. The results are then copied back to the Cloud Storage bucket.

## Prerequisites

*   A Google Cloud Platform project with the Batch API enabled.
*   `gcloud` CLI installed and authenticated.
*   `gsutil` installed and authenticated.
*   `uuid` or `uuidgen` command-line utility.
*   `envsubst` command-line utility.

## Usage

1.  **Set up the environment:**

    Make sure you have a GCP project set up and you are logged in with the `gcloud` CLI.

2.  **Create the GCS bucket and configuration file:**

    Run the `create_bucket.sh` script. This will:
    *   Create a new GCS bucket with a unique name.
    *   Upload the `parabricks.sh` script to the bucket.
    *   Create the `parabricks.json` file from the `parabricks-tpl.json` template, substituting the bucket name.

    ```bash
    bash create_bucket.sh
    ```

3.  **Submit the Batch job:**

    Use the `gcloud` CLI to submit the `parabricks.json` file to the Batch API.

    ```bash
    gcloud batch jobs submit parabricks-job --location <your-gcp-region> --config parabricks.json
    ```
    Replace `<your-gcp-region>` with the GCP region you want to run the job in (e.g., `us-central1`). The location in `parabricks.json` is set to `asia-northeast3-b`, so you might want to change that to a region closer to you.

4.  **Monitor the job:**

    You can monitor the job's progress in the Google Cloud Console under the Batch section.

5.  **Get the results:**

    Once the job is complete, the output files (`deepvariant.vcf`, `fq2bam_output.bam`, and `fq2bam_output.bam.bai`) will be available in the GCS bucket created in step 2.

## File Descriptions

*   `create_bucket.sh`: A shell script that creates a GCS bucket, uploads the `parabricks.sh` script, and generates the `parabricks.json` configuration file from the template.
*   `parabricks-tpl.json`: A template for the Batch job configuration. It contains a placeholder for the GCS bucket name.
*   `parabricks.json`: The final Batch job configuration file, generated by `create_bucket.sh`.
*   `parabricks.sh`: The main script that is executed by the Batch job. It downloads sample data, and runs the Parabricks `fq2bam` and `deepvariant` tools.
*   `README.md`: This file.
