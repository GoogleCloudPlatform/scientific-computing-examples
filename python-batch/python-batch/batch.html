<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.1.0"/>
    <title>python-batch.batch API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#FLAGS">FLAGS</a>
            </li>
            <li>
                    <a class="class" href="#PubSub">PubSub</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PubSub.__init__">PubSub</a>
                        </li>
                        <li>
                                <a class="variable" href="#PubSub.config">config</a>
                        </li>
                        <li>
                                <a class="variable" href="#PubSub.job_id">job_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#PubSub.publisher">publisher</a>
                        </li>
                        <li>
                                <a class="function" href="#PubSub.create_topic">create_topic</a>
                        </li>
                        <li>
                                <a class="function" href="#PubSub.create_subscription">create_subscription</a>
                        </li>
                        <li>
                                <a class="function" href="#PubSub.publish_fifo_ids">publish_fifo_ids</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Jobs">Jobs</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Jobs.__init__">Jobs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Jobs.config">config</a>
                        </li>
                        <li>
                                <a class="variable" href="#Jobs.job_id">job_id</a>
                        </li>
                        <li>
                                <a class="function" href="#Jobs.create_job">create_job</a>
                        </li>
                        <li>
                                <a class="function" href="#Jobs.delete_job">delete_job</a>
                        </li>
                        <li>
                                <a class="function" href="#Jobs.list_jobs">list_jobs</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#parse_yaml_file">parse_yaml_file</a>
            </li>
            <li>
                    <a class="function" href="#main">main</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
python-batch<wbr>.batch    </h1>

                        <div class="docstring"><p>Tools to run Google Cloud Batch API</p>
</div>

                        <input id="mod-batch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-batch-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="c1">#  Copyright 2023 Google LLC</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="c1">#</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="c1">#  you may not use this file except in compliance with the License.</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="c1">#  You may obtain a copy of the License at</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="c1">#</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="c1">#</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="c1">#  See the License for the specific language governing permissions and</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="c1">#  limitations under the License.</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">Tools to run Google Cloud Batch API</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;J Ross Thomson drj@&quot;</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">import</span> <span class="nn">json</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">import</span> <span class="nn">uuid</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">import</span> <span class="nn">yaml</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">app</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">flags</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">from</span> <span class="nn">google.api_core.operation</span> <span class="kn">import</span> <span class="n">Operation</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">batch_v1</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">pubsub_v1</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="kn">from</span> <span class="nn">yaml.loader</span> <span class="kn">import</span> <span class="n">SafeLoader</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">We define multiple command line flags:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="s2">&quot;config_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Config file in YAML&quot;</span><span class="p">)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_boolean</span><span class="p">(</span><span class="s2">&quot;pubsub&quot;</span><span class="p">,</span> <span class="kc">False</span> <span class="p">,</span> <span class="s2">&quot;Run Pubsub Topic and Subscriber&quot;</span><span class="p">)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="s2">&quot;previous_job_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;For Pubsub restart, specifies topic to read from&quot;</span><span class="p">)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="s2">&quot;project_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Google Cloud Project ID, not name&quot;</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_spaceseplist</span><span class="p">(</span><span class="s2">&quot;volumes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;List of GCS paths to mount. Example, </span><span class="se">\&quot;</span><span class="s2">bucket_name1:mountpath1 bucket_name2:mountpath2</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_boolean</span><span class="p">(</span><span class="s2">&quot;create_job&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Creates job, otherwise just prints config.&quot;</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_boolean</span><span class="p">(</span><span class="s2">&quot;list_jobs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;If true, list jobs for config.&quot;</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="s2">&quot;delete_job&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Job name to delete.&quot;</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_boolean</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;If true, print debug info.&quot;</span><span class="p">)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="c1"># Required flag.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="n">flags</span><span class="o">.</span><span class="n">mark_flag_as_required</span><span class="p">(</span><span class="s2">&quot;config_file&quot;</span><span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="k">class</span> <span class="nc">PubSub</span><span class="p">:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;Class to create Pub/Sub related cloud resources.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">      Used to create a topic and a subscription. </span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">      Topic name identical to job_id and subscription is `sub-` + job_id.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">      Args: </span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">          config: </span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">            Contains the structure defined by the Config.yaml file. </span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">          job_id: </span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">            The name of the job, which becomes the name of the pubsub topic.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">      Raises:</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">        None</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">      `project_id` is set  based on config, env, or argv in that order.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]:</span> 
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]</span> 
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">):</span> 
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">)</span> 
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>      <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>      <span class="n">publisher_options</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">PublisherOptions</span><span class="p">(</span><span class="n">enable_message_ordering</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">      Sending messages to the same region ensures they are received in order</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">      even when multiple publishers are used.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>      <span class="n">client_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;api_endpoint&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-pubsub.googleapis.com:443&#39;</span><span class="p">}</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">PublisherClient</span><span class="p">(</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>          <span class="n">publisher_options</span><span class="o">=</span><span class="n">publisher_options</span><span class="p">,</span> <span class="n">client_options</span><span class="o">=</span><span class="n">client_options</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>      <span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>  <span class="k">def</span> <span class="nf">create_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">    Creates a topic with name the same as Job.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">    The `topic_path` method creates a fully qualified identifier</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">    in the form `projects/{project_id}/topics/{topic_id}`</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    Args:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">      None</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">    Returns:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">      None</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">create_topic</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">})</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created topic </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>  <span class="k">def</span> <span class="nf">create_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">    Creates a subscription with name the same as `sub-` + Job.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">    Subscription will be ordered and have exactly one time delivery.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">    Args:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">      previous_job_id: if specified, the subscription is connected to a previous pubsub subscription.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">    Returns:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">      None</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">SubscriberClient</span><span class="p">()</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">=</span> <span class="s2">&quot;sub-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="k">if</span> <span class="n">previous_job_id</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">previous_job_id</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="o">.</span><span class="n">subscription_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span><span class="p">)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="n">request</span><span class="o">=</span><span class="p">{</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span><span class="p">,</span> 
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>          <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>          <span class="s2">&quot;enable_message_ordering&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>          <span class="s2">&quot;enable_exactly_once_delivery&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="p">}</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>      <span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created subscription </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>  <span class="k">def</span> <span class="nf">publish_fifo_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">    Publish integer ID messages to the pubsub topic.</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">    Simple queue create via the Pubsub Topic to create queue. </span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">    If the queue is not fully pulled, the project can restart with the same queue.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">    Picking up where it left off.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">    Args:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">      None</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">    Returns:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">      None</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">order_key</span> <span class="o">=</span> <span class="s2">&quot;fifo&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task_count&quot;</span><span class="p">]</span> <span class="p">):</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="c1"># Data must be a bytestring</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="c1"># When you publish a message, the client returns a future.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">ordering_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_key</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Future: </span><span class="si">{</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="si">}</span><span class="s1">, Message: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="k">class</span> <span class="nc">Jobs</span><span class="p">:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">    Class to create all cloud resources for Batch Jobs</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">    Args:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">      job_id: an arbitrary string to name the job.</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">      config: data structure from YAML to represent everything in the config file.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">    Returns:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">      None</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>    
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="c1">#set  &quot;project_id&quot;  based on config, env, or argv in that order.</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>  
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]:</span> 
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]</span> 
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">):</span> 
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">)</span> 
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>    <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>  <span class="k">def</span> <span class="nf">_create_runnable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="p">:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="p">()</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;variables&quot;</span><span class="p">:{</span><span class="s2">&quot;JOB_ID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">}}</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="k">if</span> <span class="s2">&quot;container&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="o">.</span><span class="n">Container</span><span class="p">()</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">image_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="s2">&quot;image_uri&quot;</span><span class="p">]</span> 
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">entrypoint</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="s2">&quot;entry_point&quot;</span><span class="p">]</span> 
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span> 
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="s2">&quot;--privileged&quot;</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>      <span class="k">if</span> <span class="s2">&quot;install_gpu_drivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/var/lib/nvidia/lib64:/usr/local/nvidia/lib64&quot;</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/var/lib/nvidia/bin:/usr/local/nvidia/bin&quot;</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="o">.</span><span class="n">Script</span><span class="p">()</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;script_text&quot;</span><span class="p">]</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>    
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>  <span class="k">def</span> <span class="nf">_create_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">TaskSpec</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">    _summary_</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">    :return: _description_</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">    :rtype: batch_v1.TaskSpec</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">TaskSpec</span><span class="p">()</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">max_retry_count</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">max_run_duration</span> <span class="o">=</span> <span class="s2">&quot;604800s&quot;</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>    <span class="k">if</span> <span class="s2">&quot;nfs_server&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>      <span class="n">nfs_server</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">NFS</span><span class="p">()</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>      <span class="n">nfs_server</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nfs_server&quot;</span><span class="p">]</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>      <span class="n">nfs_server</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nfs_remote_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;nfs_remote_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;/nfshare&quot;</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>      <span class="n">nfs_volume</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Volume</span><span class="p">()</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>      <span class="n">nfs_volume</span><span class="o">.</span><span class="n">nfs</span> <span class="o">=</span> <span class="n">nfs_server</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>      <span class="n">nfs_volume</span><span class="o">.</span><span class="n">mount_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nfs_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;nfs_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;/mnt/nfs&quot;</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nfs_volume</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="c1"># Use commmand line flags first, then config file, to set</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="c1"># gcs bucket mounts</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>    <span class="k">if</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">volumes</span><span class="p">):</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>      <span class="k">for</span> <span class="n">volume_pair</span> <span class="ow">in</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">volumes</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">gcs_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">volume_pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;bucket_name&quot;</span><span class="p">:</span><span class="n">bucket_name</span><span class="p">,</span> <span class="s2">&quot;gcs_path&quot;</span><span class="p">:</span><span class="n">gcs_path</span><span class="p">})</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>    <span class="k">elif</span> <span class="s2">&quot;volumes&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;volumes&quot;</span><span class="p">]</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>      
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>      <span class="n">gcs_volume</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Volume</span><span class="p">()</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>      <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="n">gcs_bucket</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">GCS</span><span class="p">()</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="n">gcs_bucket</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="n">volume</span><span class="p">[</span><span class="s2">&quot;bucket_name&quot;</span><span class="p">]</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="n">gcs_volume</span><span class="o">.</span><span class="n">mount_path</span> <span class="o">=</span> <span class="n">volume</span><span class="p">[</span><span class="s2">&quot;gcs_path&quot;</span><span class="p">]</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="n">gcs_volume</span><span class="o">.</span><span class="n">gcs</span> <span class="o">=</span> <span class="n">gcs_bucket</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gcs_volume</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="s2">&quot;container&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="n">volume</span><span class="p">[</span><span class="s2">&quot;gcs_path&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="n">volume</span><span class="p">[</span><span class="s2">&quot;gcs_path&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;:rw&quot;</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>  <span class="c1"># We can specify what resources are requoested by each task.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>    <span class="n">resources</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">ComputeResource</span><span class="p">()</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>    <span class="n">resources</span><span class="o">.</span><span class="n">cpu_milli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cpu_milli&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;cpu_milli&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1000</span> 
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>    <span class="n">resources</span><span class="o">.</span><span class="n">memory_mib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;memory_mib&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;memory_mib&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">102400</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>    <span class="n">resources</span><span class="o">.</span><span class="n">boot_disk_mib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;boot_disk_mib&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;boot_disk_mib&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">102400</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">compute_resource</span> <span class="o">=</span> <span class="n">resources</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>  <span class="k">def</span> <span class="nf">_create_allocation_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="p">:</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>      <span class="c1"># Policies are used to define on what kind of virtual machines the tasks will run on.</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>      <span class="c1"># In this case, we tell the system to use an instance template that defines all the</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>      <span class="c1"># required parameters.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="p">()</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">InstancePolicyOrTemplate</span><span class="p">()</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">InstancePolicy</span><span class="p">()</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">Accelerator</span><span class="p">()</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">network_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">NetworkPolicy</span><span class="p">()</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">NetworkInterface</span><span class="p">()</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>      <span class="k">if</span> <span class="s2">&quot;template_link&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">instance_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;template_link&quot;</span><span class="p">]</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>      <span class="k">elif</span> <span class="s2">&quot;machine_type&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span><span class="o">.</span><span class="n">machine_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;machine_type&quot;</span><span class="p">]</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="s2">&quot;accelerator&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">type_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;accelerator&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;accelerator&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span><span class="o">.</span><span class="n">accelerators</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="p">]</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="s2">&quot;install_gpu_drivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">install_gpu_drivers</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>          
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="k">raise</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No instance policy defined.&quot;</span><span class="p">))</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>      <span class="n">location_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">LocationPolicy</span><span class="p">()</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">]</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>      <span class="k">if</span> <span class="s2">&quot;network&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="k">if</span> <span class="s2">&quot;no_external_ip_address&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">no_external_ip_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;no_external_ip_address&quot;</span><span class="p">]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">subnetwork</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;regions/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s1">/subnetworks/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subnetwork&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>          
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;projects/</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="w"> </span><span class="si">}</span><span class="s1">/global/networks/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network_policy</span><span class="o">.</span><span class="n">network_interfaces</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_policy</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>      <span class="k">if</span> <span class="s2">&quot;allowed_locations&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="n">location_policy</span><span class="o">.</span><span class="n">allowed_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;allowed_locations&quot;</span><span class="p">]</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location_policy</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>      <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>    
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>  <span class="k">def</span> <span class="nf">_create_taskgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="sd">        Tasks are grouped inside a job using TaskGroups.</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="sd">        Currently, it&#39;s possible to have only one task group.</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">task_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">task_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task_count&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;task_count&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">parallelism</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;parallelism&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;parallelism&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">task_count_per_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task_count_per_node&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;task_count_per_node&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>      <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>  <span class="k">def</span> <span class="nf">create_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;Creates job after configuration is completed. </span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">()</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;hpc&quot;</span><span class="p">}</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">task_groups</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">allocation_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>      <span class="c1"># We use Cloud Logging as it&#39;s an out of the box available option</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">logs_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">LogsPolicy</span><span class="p">()</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">logs_policy</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">LogsPolicy</span><span class="o">.</span><span class="n">Destination</span><span class="o">.</span><span class="n">CLOUD_LOGGING</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>      <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>  <span class="k">def</span> <span class="nf">_create_job_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>      <span class="c1"># Define what will be done as part of the job.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_runnable</span><span class="p">()</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">()</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">runnables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="p">]</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_taskgroup</span><span class="p">()</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_allocation_policy</span><span class="p">()</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">create_job</span><span class="p">()</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>      <span class="n">create_request</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">CreateJobRequest</span><span class="p">()</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>      <span class="n">create_request</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>      <span class="n">create_request</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>      
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>      <span class="c1"># The job&#39;s parent is the region in which the job will run</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>      <span class="n">create_request</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;projects/</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="w"> </span><span class="si">}</span><span class="s1">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>      <span class="k">return</span><span class="p">(</span><span class="n">create_request</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>  <span class="c1"># [END batch_create_job_with_template]</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>  <span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete_job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Operation</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">      Triggers the deletion of a Job.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">      Args:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">        delete_job: name of the job to delete</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">      Returns:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">          An operation object related to the deletion. You can call `.result()`</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">          on it to wait for its completion.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>      <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>      <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/jobs/</span><span class="si">{</span><span class="n">delete_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>  <span class="k">def</span> <span class="nf">list_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">]:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">      Get a list of all jobs defined in given region.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">      Returns:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">          An iterable collection of Job object.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>      <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>      <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="k">def</span> <span class="nf">parse_yaml_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">  Parse the provided YAML file to get the job configuration</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">  :param file_name: The path to the YAML configuration file</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">  :type file_name: str</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">SafeLoader</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">  This is where the Job and Pubsub objects are created and used.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">  :param argv: Standard commandline arguments</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">  :type argv: _type_</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>  <span class="n">config</span> <span class="o">=</span> <span class="n">parse_yaml_file</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">config_file</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>  <span class="n">jobid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;job_prefix&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>  <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>  <span class="n">jobs</span> <span class="o">=</span> <span class="n">Jobs</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>  <span class="c1"># This does not create the job yet</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>  <span class="n">create_request</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">_create_job_request</span><span class="p">()</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>  <span class="k">if</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">delete_job</span><span class="p">):</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting job&quot;</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>    <span class="n">deleted_job</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">delete_job</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">deleted_job</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>    <span class="n">exit</span><span class="p">()</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>  <span class="k">if</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Listing jobs&quot;</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>    <span class="n">jobs</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">()</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>      <span class="nb">print</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>    <span class="n">exit</span><span class="p">()</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>  <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>    
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>    <span class="c1"># If pubsub queue is required </span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>  <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">pubsub</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>    <span class="n">pubsub</span> <span class="o">=</span> <span class="n">PubSub</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>    <span class="c1"># If there is a previous queue to read from:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">previous_job_id</span><span class="p">:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">previous_job_id</span><span class="o">=</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">previous_job_id</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">create_topic</span><span class="p">()</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">()</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">publish_fifo_ids</span><span class="p">()</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>  <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">create_job</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>    <span class="c1"># Create the job</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">create_job</span><span class="p">(</span><span class="n">create_request</span><span class="p">))</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>  <span class="k">else</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">create_request</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; This is executed when run from the command line &quot;&quot;&quot;</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="FLAGS">
                    <div class="attr variable">
            <span class="name">FLAGS</span>        =
<span class="default_value">&lt;absl.flags._flagvalues.FlagValues object&gt;</span>

        
    </div>
    <a class="headerlink" href="#FLAGS"></a>
    
    

                </section>
                <section id="PubSub">
                            <input id="PubSub-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PubSub</span>:

                <label class="view-source-button" for="PubSub-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PubSub"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PubSub-57"><a href="#PubSub-57"><span class="linenos"> 57</span></a><span class="k">class</span> <span class="nc">PubSub</span><span class="p">:</span>
</span><span id="PubSub-58"><a href="#PubSub-58"><span class="linenos"> 58</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PubSub-59"><a href="#PubSub-59"><span class="linenos"> 59</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;Class to create Pub/Sub related cloud resources.</span>
</span><span id="PubSub-60"><a href="#PubSub-60"><span class="linenos"> 60</span></a>
</span><span id="PubSub-61"><a href="#PubSub-61"><span class="linenos"> 61</span></a><span class="sd">      Used to create a topic and a subscription. </span>
</span><span id="PubSub-62"><a href="#PubSub-62"><span class="linenos"> 62</span></a><span class="sd">      Topic name identical to job_id and subscription is `sub-` + job_id.</span>
</span><span id="PubSub-63"><a href="#PubSub-63"><span class="linenos"> 63</span></a>
</span><span id="PubSub-64"><a href="#PubSub-64"><span class="linenos"> 64</span></a><span class="sd">      Args: </span>
</span><span id="PubSub-65"><a href="#PubSub-65"><span class="linenos"> 65</span></a><span class="sd">          config: </span>
</span><span id="PubSub-66"><a href="#PubSub-66"><span class="linenos"> 66</span></a><span class="sd">            Contains the structure defined by the Config.yaml file. </span>
</span><span id="PubSub-67"><a href="#PubSub-67"><span class="linenos"> 67</span></a><span class="sd">          job_id: </span>
</span><span id="PubSub-68"><a href="#PubSub-68"><span class="linenos"> 68</span></a><span class="sd">            The name of the job, which becomes the name of the pubsub topic.</span>
</span><span id="PubSub-69"><a href="#PubSub-69"><span class="linenos"> 69</span></a>
</span><span id="PubSub-70"><a href="#PubSub-70"><span class="linenos"> 70</span></a><span class="sd">      Raises:</span>
</span><span id="PubSub-71"><a href="#PubSub-71"><span class="linenos"> 71</span></a><span class="sd">        None</span>
</span><span id="PubSub-72"><a href="#PubSub-72"><span class="linenos"> 72</span></a>
</span><span id="PubSub-73"><a href="#PubSub-73"><span class="linenos"> 73</span></a><span class="sd">      `project_id` is set  based on config, env, or argv in that order.</span>
</span><span id="PubSub-74"><a href="#PubSub-74"><span class="linenos"> 74</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="PubSub-75"><a href="#PubSub-75"><span class="linenos"> 75</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="PubSub-76"><a href="#PubSub-76"><span class="linenos"> 76</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
</span><span id="PubSub-77"><a href="#PubSub-77"><span class="linenos"> 77</span></a>
</span><span id="PubSub-78"><a href="#PubSub-78"><span class="linenos"> 78</span></a>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]:</span> 
</span><span id="PubSub-79"><a href="#PubSub-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]</span> 
</span><span id="PubSub-80"><a href="#PubSub-80"><span class="linenos"> 80</span></a>      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">):</span> 
</span><span id="PubSub-81"><a href="#PubSub-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">)</span> 
</span><span id="PubSub-82"><a href="#PubSub-82"><span class="linenos"> 82</span></a>      <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span><span class="p">:</span>
</span><span id="PubSub-83"><a href="#PubSub-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span>
</span><span id="PubSub-84"><a href="#PubSub-84"><span class="linenos"> 84</span></a>
</span><span id="PubSub-85"><a href="#PubSub-85"><span class="linenos"> 85</span></a>      <span class="n">publisher_options</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">PublisherOptions</span><span class="p">(</span><span class="n">enable_message_ordering</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PubSub-86"><a href="#PubSub-86"><span class="linenos"> 86</span></a>
</span><span id="PubSub-87"><a href="#PubSub-87"><span class="linenos"> 87</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub-88"><a href="#PubSub-88"><span class="linenos"> 88</span></a><span class="sd">      Sending messages to the same region ensures they are received in order</span>
</span><span id="PubSub-89"><a href="#PubSub-89"><span class="linenos"> 89</span></a><span class="sd">      even when multiple publishers are used.</span>
</span><span id="PubSub-90"><a href="#PubSub-90"><span class="linenos"> 90</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="PubSub-91"><a href="#PubSub-91"><span class="linenos"> 91</span></a>
</span><span id="PubSub-92"><a href="#PubSub-92"><span class="linenos"> 92</span></a>      <span class="n">client_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;api_endpoint&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-pubsub.googleapis.com:443&#39;</span><span class="p">}</span>
</span><span id="PubSub-93"><a href="#PubSub-93"><span class="linenos"> 93</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">PublisherClient</span><span class="p">(</span>
</span><span id="PubSub-94"><a href="#PubSub-94"><span class="linenos"> 94</span></a>          <span class="n">publisher_options</span><span class="o">=</span><span class="n">publisher_options</span><span class="p">,</span> <span class="n">client_options</span><span class="o">=</span><span class="n">client_options</span>
</span><span id="PubSub-95"><a href="#PubSub-95"><span class="linenos"> 95</span></a>      <span class="p">)</span>
</span><span id="PubSub-96"><a href="#PubSub-96"><span class="linenos"> 96</span></a>
</span><span id="PubSub-97"><a href="#PubSub-97"><span class="linenos"> 97</span></a>  <span class="k">def</span> <span class="nf">create_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PubSub-98"><a href="#PubSub-98"><span class="linenos"> 98</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub-99"><a href="#PubSub-99"><span class="linenos"> 99</span></a><span class="sd">    Creates a topic with name the same as Job.</span>
</span><span id="PubSub-100"><a href="#PubSub-100"><span class="linenos">100</span></a>
</span><span id="PubSub-101"><a href="#PubSub-101"><span class="linenos">101</span></a><span class="sd">    The `topic_path` method creates a fully qualified identifier</span>
</span><span id="PubSub-102"><a href="#PubSub-102"><span class="linenos">102</span></a><span class="sd">    in the form `projects/{project_id}/topics/{topic_id}`</span>
</span><span id="PubSub-103"><a href="#PubSub-103"><span class="linenos">103</span></a>
</span><span id="PubSub-104"><a href="#PubSub-104"><span class="linenos">104</span></a><span class="sd">    Args:</span>
</span><span id="PubSub-105"><a href="#PubSub-105"><span class="linenos">105</span></a><span class="sd">      None</span>
</span><span id="PubSub-106"><a href="#PubSub-106"><span class="linenos">106</span></a>
</span><span id="PubSub-107"><a href="#PubSub-107"><span class="linenos">107</span></a><span class="sd">    Returns:</span>
</span><span id="PubSub-108"><a href="#PubSub-108"><span class="linenos">108</span></a><span class="sd">      None</span>
</span><span id="PubSub-109"><a href="#PubSub-109"><span class="linenos">109</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PubSub-110"><a href="#PubSub-110"><span class="linenos">110</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
</span><span id="PubSub-111"><a href="#PubSub-111"><span class="linenos">111</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">create_topic</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">})</span>
</span><span id="PubSub-112"><a href="#PubSub-112"><span class="linenos">112</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created topic </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PubSub-113"><a href="#PubSub-113"><span class="linenos">113</span></a>
</span><span id="PubSub-114"><a href="#PubSub-114"><span class="linenos">114</span></a>  <span class="k">def</span> <span class="nf">create_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PubSub-115"><a href="#PubSub-115"><span class="linenos">115</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub-116"><a href="#PubSub-116"><span class="linenos">116</span></a><span class="sd">    Creates a subscription with name the same as `sub-` + Job.</span>
</span><span id="PubSub-117"><a href="#PubSub-117"><span class="linenos">117</span></a>
</span><span id="PubSub-118"><a href="#PubSub-118"><span class="linenos">118</span></a><span class="sd">    Subscription will be ordered and have exactly one time delivery.</span>
</span><span id="PubSub-119"><a href="#PubSub-119"><span class="linenos">119</span></a>
</span><span id="PubSub-120"><a href="#PubSub-120"><span class="linenos">120</span></a><span class="sd">    Args:</span>
</span><span id="PubSub-121"><a href="#PubSub-121"><span class="linenos">121</span></a><span class="sd">      previous_job_id: if specified, the subscription is connected to a previous pubsub subscription.</span>
</span><span id="PubSub-122"><a href="#PubSub-122"><span class="linenos">122</span></a>
</span><span id="PubSub-123"><a href="#PubSub-123"><span class="linenos">123</span></a><span class="sd">    Returns:</span>
</span><span id="PubSub-124"><a href="#PubSub-124"><span class="linenos">124</span></a><span class="sd">      None</span>
</span><span id="PubSub-125"><a href="#PubSub-125"><span class="linenos">125</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PubSub-126"><a href="#PubSub-126"><span class="linenos">126</span></a>
</span><span id="PubSub-127"><a href="#PubSub-127"><span class="linenos">127</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">SubscriberClient</span><span class="p">()</span>
</span><span id="PubSub-128"><a href="#PubSub-128"><span class="linenos">128</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">=</span> <span class="s2">&quot;sub-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
</span><span id="PubSub-129"><a href="#PubSub-129"><span class="linenos">129</span></a>
</span><span id="PubSub-130"><a href="#PubSub-130"><span class="linenos">130</span></a>    <span class="k">if</span> <span class="n">previous_job_id</span><span class="p">:</span>
</span><span id="PubSub-131"><a href="#PubSub-131"><span class="linenos">131</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">previous_job_id</span><span class="p">)</span>
</span><span id="PubSub-132"><a href="#PubSub-132"><span class="linenos">132</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="PubSub-133"><a href="#PubSub-133"><span class="linenos">133</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
</span><span id="PubSub-134"><a href="#PubSub-134"><span class="linenos">134</span></a>
</span><span id="PubSub-135"><a href="#PubSub-135"><span class="linenos">135</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="o">.</span><span class="n">subscription_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span><span class="p">)</span>
</span><span id="PubSub-136"><a href="#PubSub-136"><span class="linenos">136</span></a>
</span><span id="PubSub-137"><a href="#PubSub-137"><span class="linenos">137</span></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="p">:</span>
</span><span id="PubSub-138"><a href="#PubSub-138"><span class="linenos">138</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
</span><span id="PubSub-139"><a href="#PubSub-139"><span class="linenos">139</span></a>        <span class="n">request</span><span class="o">=</span><span class="p">{</span>
</span><span id="PubSub-140"><a href="#PubSub-140"><span class="linenos">140</span></a>          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span><span class="p">,</span> 
</span><span id="PubSub-141"><a href="#PubSub-141"><span class="linenos">141</span></a>          <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">,</span>
</span><span id="PubSub-142"><a href="#PubSub-142"><span class="linenos">142</span></a>          <span class="s2">&quot;enable_message_ordering&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="PubSub-143"><a href="#PubSub-143"><span class="linenos">143</span></a>          <span class="s2">&quot;enable_exactly_once_delivery&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="PubSub-144"><a href="#PubSub-144"><span class="linenos">144</span></a>        <span class="p">}</span>
</span><span id="PubSub-145"><a href="#PubSub-145"><span class="linenos">145</span></a>      <span class="p">)</span>
</span><span id="PubSub-146"><a href="#PubSub-146"><span class="linenos">146</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created subscription </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PubSub-147"><a href="#PubSub-147"><span class="linenos">147</span></a>    
</span><span id="PubSub-148"><a href="#PubSub-148"><span class="linenos">148</span></a>
</span><span id="PubSub-149"><a href="#PubSub-149"><span class="linenos">149</span></a>  <span class="k">def</span> <span class="nf">publish_fifo_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PubSub-150"><a href="#PubSub-150"><span class="linenos">150</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub-151"><a href="#PubSub-151"><span class="linenos">151</span></a><span class="sd">    Publish integer ID messages to the pubsub topic.</span>
</span><span id="PubSub-152"><a href="#PubSub-152"><span class="linenos">152</span></a>
</span><span id="PubSub-153"><a href="#PubSub-153"><span class="linenos">153</span></a><span class="sd">    Simple queue create via the Pubsub Topic to create queue. </span>
</span><span id="PubSub-154"><a href="#PubSub-154"><span class="linenos">154</span></a><span class="sd">    If the queue is not fully pulled, the project can restart with the same queue.</span>
</span><span id="PubSub-155"><a href="#PubSub-155"><span class="linenos">155</span></a><span class="sd">    Picking up where it left off.</span>
</span><span id="PubSub-156"><a href="#PubSub-156"><span class="linenos">156</span></a>
</span><span id="PubSub-157"><a href="#PubSub-157"><span class="linenos">157</span></a><span class="sd">    Args:</span>
</span><span id="PubSub-158"><a href="#PubSub-158"><span class="linenos">158</span></a><span class="sd">      None</span>
</span><span id="PubSub-159"><a href="#PubSub-159"><span class="linenos">159</span></a>
</span><span id="PubSub-160"><a href="#PubSub-160"><span class="linenos">160</span></a><span class="sd">    Returns:</span>
</span><span id="PubSub-161"><a href="#PubSub-161"><span class="linenos">161</span></a><span class="sd">      None</span>
</span><span id="PubSub-162"><a href="#PubSub-162"><span class="linenos">162</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PubSub-163"><a href="#PubSub-163"><span class="linenos">163</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">order_key</span> <span class="o">=</span> <span class="s2">&quot;fifo&quot;</span>
</span><span id="PubSub-164"><a href="#PubSub-164"><span class="linenos">164</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task_count&quot;</span><span class="p">]</span> <span class="p">):</span>
</span><span id="PubSub-165"><a href="#PubSub-165"><span class="linenos">165</span></a>        <span class="c1"># Data must be a bytestring</span>
</span><span id="PubSub-166"><a href="#PubSub-166"><span class="linenos">166</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="PubSub-167"><a href="#PubSub-167"><span class="linenos">167</span></a>        <span class="c1"># When you publish a message, the client returns a future.</span>
</span><span id="PubSub-168"><a href="#PubSub-168"><span class="linenos">168</span></a>        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">ordering_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_key</span><span class="p">)</span>
</span><span id="PubSub-169"><a href="#PubSub-169"><span class="linenos">169</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Future: </span><span class="si">{</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="si">}</span><span class="s1">, Message: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></pre></div>


    

                            <div id="PubSub.__init__" class="classattr">
                                        <input id="PubSub.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PubSub</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">config</span></span>)</span>

                <label class="view-source-button" for="PubSub.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PubSub.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PubSub.__init__-58"><a href="#PubSub.__init__-58"><span class="linenos">58</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PubSub.__init__-59"><a href="#PubSub.__init__-59"><span class="linenos">59</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;Class to create Pub/Sub related cloud resources.</span>
</span><span id="PubSub.__init__-60"><a href="#PubSub.__init__-60"><span class="linenos">60</span></a>
</span><span id="PubSub.__init__-61"><a href="#PubSub.__init__-61"><span class="linenos">61</span></a><span class="sd">      Used to create a topic and a subscription. </span>
</span><span id="PubSub.__init__-62"><a href="#PubSub.__init__-62"><span class="linenos">62</span></a><span class="sd">      Topic name identical to job_id and subscription is `sub-` + job_id.</span>
</span><span id="PubSub.__init__-63"><a href="#PubSub.__init__-63"><span class="linenos">63</span></a>
</span><span id="PubSub.__init__-64"><a href="#PubSub.__init__-64"><span class="linenos">64</span></a><span class="sd">      Args: </span>
</span><span id="PubSub.__init__-65"><a href="#PubSub.__init__-65"><span class="linenos">65</span></a><span class="sd">          config: </span>
</span><span id="PubSub.__init__-66"><a href="#PubSub.__init__-66"><span class="linenos">66</span></a><span class="sd">            Contains the structure defined by the Config.yaml file. </span>
</span><span id="PubSub.__init__-67"><a href="#PubSub.__init__-67"><span class="linenos">67</span></a><span class="sd">          job_id: </span>
</span><span id="PubSub.__init__-68"><a href="#PubSub.__init__-68"><span class="linenos">68</span></a><span class="sd">            The name of the job, which becomes the name of the pubsub topic.</span>
</span><span id="PubSub.__init__-69"><a href="#PubSub.__init__-69"><span class="linenos">69</span></a>
</span><span id="PubSub.__init__-70"><a href="#PubSub.__init__-70"><span class="linenos">70</span></a><span class="sd">      Raises:</span>
</span><span id="PubSub.__init__-71"><a href="#PubSub.__init__-71"><span class="linenos">71</span></a><span class="sd">        None</span>
</span><span id="PubSub.__init__-72"><a href="#PubSub.__init__-72"><span class="linenos">72</span></a>
</span><span id="PubSub.__init__-73"><a href="#PubSub.__init__-73"><span class="linenos">73</span></a><span class="sd">      `project_id` is set  based on config, env, or argv in that order.</span>
</span><span id="PubSub.__init__-74"><a href="#PubSub.__init__-74"><span class="linenos">74</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="PubSub.__init__-75"><a href="#PubSub.__init__-75"><span class="linenos">75</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="PubSub.__init__-76"><a href="#PubSub.__init__-76"><span class="linenos">76</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
</span><span id="PubSub.__init__-77"><a href="#PubSub.__init__-77"><span class="linenos">77</span></a>
</span><span id="PubSub.__init__-78"><a href="#PubSub.__init__-78"><span class="linenos">78</span></a>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]:</span> 
</span><span id="PubSub.__init__-79"><a href="#PubSub.__init__-79"><span class="linenos">79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]</span> 
</span><span id="PubSub.__init__-80"><a href="#PubSub.__init__-80"><span class="linenos">80</span></a>      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">):</span> 
</span><span id="PubSub.__init__-81"><a href="#PubSub.__init__-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">)</span> 
</span><span id="PubSub.__init__-82"><a href="#PubSub.__init__-82"><span class="linenos">82</span></a>      <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span><span class="p">:</span>
</span><span id="PubSub.__init__-83"><a href="#PubSub.__init__-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span>
</span><span id="PubSub.__init__-84"><a href="#PubSub.__init__-84"><span class="linenos">84</span></a>
</span><span id="PubSub.__init__-85"><a href="#PubSub.__init__-85"><span class="linenos">85</span></a>      <span class="n">publisher_options</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">PublisherOptions</span><span class="p">(</span><span class="n">enable_message_ordering</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PubSub.__init__-86"><a href="#PubSub.__init__-86"><span class="linenos">86</span></a>
</span><span id="PubSub.__init__-87"><a href="#PubSub.__init__-87"><span class="linenos">87</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub.__init__-88"><a href="#PubSub.__init__-88"><span class="linenos">88</span></a><span class="sd">      Sending messages to the same region ensures they are received in order</span>
</span><span id="PubSub.__init__-89"><a href="#PubSub.__init__-89"><span class="linenos">89</span></a><span class="sd">      even when multiple publishers are used.</span>
</span><span id="PubSub.__init__-90"><a href="#PubSub.__init__-90"><span class="linenos">90</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="PubSub.__init__-91"><a href="#PubSub.__init__-91"><span class="linenos">91</span></a>
</span><span id="PubSub.__init__-92"><a href="#PubSub.__init__-92"><span class="linenos">92</span></a>      <span class="n">client_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;api_endpoint&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-pubsub.googleapis.com:443&#39;</span><span class="p">}</span>
</span><span id="PubSub.__init__-93"><a href="#PubSub.__init__-93"><span class="linenos">93</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">PublisherClient</span><span class="p">(</span>
</span><span id="PubSub.__init__-94"><a href="#PubSub.__init__-94"><span class="linenos">94</span></a>          <span class="n">publisher_options</span><span class="o">=</span><span class="n">publisher_options</span><span class="p">,</span> <span class="n">client_options</span><span class="o">=</span><span class="n">client_options</span>
</span><span id="PubSub.__init__-95"><a href="#PubSub.__init__-95"><span class="linenos">95</span></a>      <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Class to create Pub/Sub related cloud resources.</p>

<p>Used to create a topic and a subscription. 
Topic name identical to job_id and subscription is <code>sub-</code> + job_id.</p>

<p>Args: 
    config: 
      Contains the structure defined by the Config.yaml file. 
    job_id: 
      The name of the job, which becomes the name of the pubsub topic.</p>

<p>Raises:
  None</p>

<p><code>project_id</code> is set  based on config, env, or argv in that order.</p>
</div>


                            </div>
                            <div id="PubSub.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span>

        
    </div>
    <a class="headerlink" href="#PubSub.config"></a>
    
    

                            </div>
                            <div id="PubSub.job_id" class="classattr">
                                <div class="attr variable">
            <span class="name">job_id</span>

        
    </div>
    <a class="headerlink" href="#PubSub.job_id"></a>
    
    

                            </div>
                            <div id="PubSub.publisher" class="classattr">
                                <div class="attr variable">
            <span class="name">publisher</span>

        
    </div>
    <a class="headerlink" href="#PubSub.publisher"></a>
    
    

                            </div>
                            <div id="PubSub.create_topic" class="classattr">
                                        <input id="PubSub.create_topic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_topic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PubSub.create_topic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PubSub.create_topic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PubSub.create_topic-97"><a href="#PubSub.create_topic-97"><span class="linenos"> 97</span></a>  <span class="k">def</span> <span class="nf">create_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PubSub.create_topic-98"><a href="#PubSub.create_topic-98"><span class="linenos"> 98</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub.create_topic-99"><a href="#PubSub.create_topic-99"><span class="linenos"> 99</span></a><span class="sd">    Creates a topic with name the same as Job.</span>
</span><span id="PubSub.create_topic-100"><a href="#PubSub.create_topic-100"><span class="linenos">100</span></a>
</span><span id="PubSub.create_topic-101"><a href="#PubSub.create_topic-101"><span class="linenos">101</span></a><span class="sd">    The `topic_path` method creates a fully qualified identifier</span>
</span><span id="PubSub.create_topic-102"><a href="#PubSub.create_topic-102"><span class="linenos">102</span></a><span class="sd">    in the form `projects/{project_id}/topics/{topic_id}`</span>
</span><span id="PubSub.create_topic-103"><a href="#PubSub.create_topic-103"><span class="linenos">103</span></a>
</span><span id="PubSub.create_topic-104"><a href="#PubSub.create_topic-104"><span class="linenos">104</span></a><span class="sd">    Args:</span>
</span><span id="PubSub.create_topic-105"><a href="#PubSub.create_topic-105"><span class="linenos">105</span></a><span class="sd">      None</span>
</span><span id="PubSub.create_topic-106"><a href="#PubSub.create_topic-106"><span class="linenos">106</span></a>
</span><span id="PubSub.create_topic-107"><a href="#PubSub.create_topic-107"><span class="linenos">107</span></a><span class="sd">    Returns:</span>
</span><span id="PubSub.create_topic-108"><a href="#PubSub.create_topic-108"><span class="linenos">108</span></a><span class="sd">      None</span>
</span><span id="PubSub.create_topic-109"><a href="#PubSub.create_topic-109"><span class="linenos">109</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PubSub.create_topic-110"><a href="#PubSub.create_topic-110"><span class="linenos">110</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
</span><span id="PubSub.create_topic-111"><a href="#PubSub.create_topic-111"><span class="linenos">111</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">create_topic</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">})</span>
</span><span id="PubSub.create_topic-112"><a href="#PubSub.create_topic-112"><span class="linenos">112</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created topic </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates a topic with name the same as Job.</p>

<p>The <code>topic_path</code> method creates a fully qualified identifier
in the form <code>projects/{project_id}/topics/{topic_id}</code></p>

<p>Args:
  None</p>

<p>Returns:
  None</p>
</div>


                            </div>
                            <div id="PubSub.create_subscription" class="classattr">
                                        <input id="PubSub.create_subscription-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_subscription</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">previous_job_id</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PubSub.create_subscription-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PubSub.create_subscription"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PubSub.create_subscription-114"><a href="#PubSub.create_subscription-114"><span class="linenos">114</span></a>  <span class="k">def</span> <span class="nf">create_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PubSub.create_subscription-115"><a href="#PubSub.create_subscription-115"><span class="linenos">115</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub.create_subscription-116"><a href="#PubSub.create_subscription-116"><span class="linenos">116</span></a><span class="sd">    Creates a subscription with name the same as `sub-` + Job.</span>
</span><span id="PubSub.create_subscription-117"><a href="#PubSub.create_subscription-117"><span class="linenos">117</span></a>
</span><span id="PubSub.create_subscription-118"><a href="#PubSub.create_subscription-118"><span class="linenos">118</span></a><span class="sd">    Subscription will be ordered and have exactly one time delivery.</span>
</span><span id="PubSub.create_subscription-119"><a href="#PubSub.create_subscription-119"><span class="linenos">119</span></a>
</span><span id="PubSub.create_subscription-120"><a href="#PubSub.create_subscription-120"><span class="linenos">120</span></a><span class="sd">    Args:</span>
</span><span id="PubSub.create_subscription-121"><a href="#PubSub.create_subscription-121"><span class="linenos">121</span></a><span class="sd">      previous_job_id: if specified, the subscription is connected to a previous pubsub subscription.</span>
</span><span id="PubSub.create_subscription-122"><a href="#PubSub.create_subscription-122"><span class="linenos">122</span></a>
</span><span id="PubSub.create_subscription-123"><a href="#PubSub.create_subscription-123"><span class="linenos">123</span></a><span class="sd">    Returns:</span>
</span><span id="PubSub.create_subscription-124"><a href="#PubSub.create_subscription-124"><span class="linenos">124</span></a><span class="sd">      None</span>
</span><span id="PubSub.create_subscription-125"><a href="#PubSub.create_subscription-125"><span class="linenos">125</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PubSub.create_subscription-126"><a href="#PubSub.create_subscription-126"><span class="linenos">126</span></a>
</span><span id="PubSub.create_subscription-127"><a href="#PubSub.create_subscription-127"><span class="linenos">127</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">pubsub_v1</span><span class="o">.</span><span class="n">SubscriberClient</span><span class="p">()</span>
</span><span id="PubSub.create_subscription-128"><a href="#PubSub.create_subscription-128"><span class="linenos">128</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">=</span> <span class="s2">&quot;sub-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
</span><span id="PubSub.create_subscription-129"><a href="#PubSub.create_subscription-129"><span class="linenos">129</span></a>
</span><span id="PubSub.create_subscription-130"><a href="#PubSub.create_subscription-130"><span class="linenos">130</span></a>    <span class="k">if</span> <span class="n">previous_job_id</span><span class="p">:</span>
</span><span id="PubSub.create_subscription-131"><a href="#PubSub.create_subscription-131"><span class="linenos">131</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">previous_job_id</span><span class="p">)</span>
</span><span id="PubSub.create_subscription-132"><a href="#PubSub.create_subscription-132"><span class="linenos">132</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="PubSub.create_subscription-133"><a href="#PubSub.create_subscription-133"><span class="linenos">133</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">topic_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
</span><span id="PubSub.create_subscription-134"><a href="#PubSub.create_subscription-134"><span class="linenos">134</span></a>
</span><span id="PubSub.create_subscription-135"><a href="#PubSub.create_subscription-135"><span class="linenos">135</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="o">.</span><span class="n">subscription_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span><span class="p">)</span>
</span><span id="PubSub.create_subscription-136"><a href="#PubSub.create_subscription-136"><span class="linenos">136</span></a>
</span><span id="PubSub.create_subscription-137"><a href="#PubSub.create_subscription-137"><span class="linenos">137</span></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="p">:</span>
</span><span id="PubSub.create_subscription-138"><a href="#PubSub.create_subscription-138"><span class="linenos">138</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriber</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
</span><span id="PubSub.create_subscription-139"><a href="#PubSub.create_subscription-139"><span class="linenos">139</span></a>        <span class="n">request</span><span class="o">=</span><span class="p">{</span>
</span><span id="PubSub.create_subscription-140"><a href="#PubSub.create_subscription-140"><span class="linenos">140</span></a>          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span><span class="p">,</span> 
</span><span id="PubSub.create_subscription-141"><a href="#PubSub.create_subscription-141"><span class="linenos">141</span></a>          <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">,</span>
</span><span id="PubSub.create_subscription-142"><a href="#PubSub.create_subscription-142"><span class="linenos">142</span></a>          <span class="s2">&quot;enable_message_ordering&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="PubSub.create_subscription-143"><a href="#PubSub.create_subscription-143"><span class="linenos">143</span></a>          <span class="s2">&quot;enable_exactly_once_delivery&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="PubSub.create_subscription-144"><a href="#PubSub.create_subscription-144"><span class="linenos">144</span></a>        <span class="p">}</span>
</span><span id="PubSub.create_subscription-145"><a href="#PubSub.create_subscription-145"><span class="linenos">145</span></a>      <span class="p">)</span>
</span><span id="PubSub.create_subscription-146"><a href="#PubSub.create_subscription-146"><span class="linenos">146</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created subscription </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates a subscription with name the same as <code>sub-</code> + Job.</p>

<p>Subscription will be ordered and have exactly one time delivery.</p>

<p>Args:
  previous_job_id: if specified, the subscription is connected to a previous pubsub subscription.</p>

<p>Returns:
  None</p>
</div>


                            </div>
                            <div id="PubSub.publish_fifo_ids" class="classattr">
                                        <input id="PubSub.publish_fifo_ids-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">publish_fifo_ids</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PubSub.publish_fifo_ids-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PubSub.publish_fifo_ids"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PubSub.publish_fifo_ids-149"><a href="#PubSub.publish_fifo_ids-149"><span class="linenos">149</span></a>  <span class="k">def</span> <span class="nf">publish_fifo_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PubSub.publish_fifo_ids-150"><a href="#PubSub.publish_fifo_ids-150"><span class="linenos">150</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PubSub.publish_fifo_ids-151"><a href="#PubSub.publish_fifo_ids-151"><span class="linenos">151</span></a><span class="sd">    Publish integer ID messages to the pubsub topic.</span>
</span><span id="PubSub.publish_fifo_ids-152"><a href="#PubSub.publish_fifo_ids-152"><span class="linenos">152</span></a>
</span><span id="PubSub.publish_fifo_ids-153"><a href="#PubSub.publish_fifo_ids-153"><span class="linenos">153</span></a><span class="sd">    Simple queue create via the Pubsub Topic to create queue. </span>
</span><span id="PubSub.publish_fifo_ids-154"><a href="#PubSub.publish_fifo_ids-154"><span class="linenos">154</span></a><span class="sd">    If the queue is not fully pulled, the project can restart with the same queue.</span>
</span><span id="PubSub.publish_fifo_ids-155"><a href="#PubSub.publish_fifo_ids-155"><span class="linenos">155</span></a><span class="sd">    Picking up where it left off.</span>
</span><span id="PubSub.publish_fifo_ids-156"><a href="#PubSub.publish_fifo_ids-156"><span class="linenos">156</span></a>
</span><span id="PubSub.publish_fifo_ids-157"><a href="#PubSub.publish_fifo_ids-157"><span class="linenos">157</span></a><span class="sd">    Args:</span>
</span><span id="PubSub.publish_fifo_ids-158"><a href="#PubSub.publish_fifo_ids-158"><span class="linenos">158</span></a><span class="sd">      None</span>
</span><span id="PubSub.publish_fifo_ids-159"><a href="#PubSub.publish_fifo_ids-159"><span class="linenos">159</span></a>
</span><span id="PubSub.publish_fifo_ids-160"><a href="#PubSub.publish_fifo_ids-160"><span class="linenos">160</span></a><span class="sd">    Returns:</span>
</span><span id="PubSub.publish_fifo_ids-161"><a href="#PubSub.publish_fifo_ids-161"><span class="linenos">161</span></a><span class="sd">      None</span>
</span><span id="PubSub.publish_fifo_ids-162"><a href="#PubSub.publish_fifo_ids-162"><span class="linenos">162</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PubSub.publish_fifo_ids-163"><a href="#PubSub.publish_fifo_ids-163"><span class="linenos">163</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">order_key</span> <span class="o">=</span> <span class="s2">&quot;fifo&quot;</span>
</span><span id="PubSub.publish_fifo_ids-164"><a href="#PubSub.publish_fifo_ids-164"><span class="linenos">164</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task_count&quot;</span><span class="p">]</span> <span class="p">):</span>
</span><span id="PubSub.publish_fifo_ids-165"><a href="#PubSub.publish_fifo_ids-165"><span class="linenos">165</span></a>        <span class="c1"># Data must be a bytestring</span>
</span><span id="PubSub.publish_fifo_ids-166"><a href="#PubSub.publish_fifo_ids-166"><span class="linenos">166</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="PubSub.publish_fifo_ids-167"><a href="#PubSub.publish_fifo_ids-167"><span class="linenos">167</span></a>        <span class="c1"># When you publish a message, the client returns a future.</span>
</span><span id="PubSub.publish_fifo_ids-168"><a href="#PubSub.publish_fifo_ids-168"><span class="linenos">168</span></a>        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topic_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">ordering_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order_key</span><span class="p">)</span>
</span><span id="PubSub.publish_fifo_ids-169"><a href="#PubSub.publish_fifo_ids-169"><span class="linenos">169</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Future: </span><span class="si">{</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="si">}</span><span class="s1">, Message: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Publish integer ID messages to the pubsub topic.</p>

<p>Simple queue create via the Pubsub Topic to create queue. 
If the queue is not fully pulled, the project can restart with the same queue.
Picking up where it left off.</p>

<p>Args:
  None</p>

<p>Returns:
  None</p>
</div>


                            </div>
                </section>
                <section id="Jobs">
                            <input id="Jobs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Jobs</span>:

                <label class="view-source-button" for="Jobs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Jobs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Jobs-174"><a href="#Jobs-174"><span class="linenos">174</span></a><span class="k">class</span> <span class="nc">Jobs</span><span class="p">:</span>
</span><span id="Jobs-175"><a href="#Jobs-175"><span class="linenos">175</span></a>
</span><span id="Jobs-176"><a href="#Jobs-176"><span class="linenos">176</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Jobs-177"><a href="#Jobs-177"><span class="linenos">177</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Jobs-178"><a href="#Jobs-178"><span class="linenos">178</span></a><span class="sd">    Class to create all cloud resources for Batch Jobs</span>
</span><span id="Jobs-179"><a href="#Jobs-179"><span class="linenos">179</span></a>
</span><span id="Jobs-180"><a href="#Jobs-180"><span class="linenos">180</span></a><span class="sd">    Args:</span>
</span><span id="Jobs-181"><a href="#Jobs-181"><span class="linenos">181</span></a><span class="sd">      job_id: an arbitrary string to name the job.</span>
</span><span id="Jobs-182"><a href="#Jobs-182"><span class="linenos">182</span></a><span class="sd">      config: data structure from YAML to represent everything in the config file.</span>
</span><span id="Jobs-183"><a href="#Jobs-183"><span class="linenos">183</span></a>
</span><span id="Jobs-184"><a href="#Jobs-184"><span class="linenos">184</span></a><span class="sd">    Returns:</span>
</span><span id="Jobs-185"><a href="#Jobs-185"><span class="linenos">185</span></a><span class="sd">      None</span>
</span><span id="Jobs-186"><a href="#Jobs-186"><span class="linenos">186</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Jobs-187"><a href="#Jobs-187"><span class="linenos">187</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="Jobs-188"><a href="#Jobs-188"><span class="linenos">188</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
</span><span id="Jobs-189"><a href="#Jobs-189"><span class="linenos">189</span></a>    
</span><span id="Jobs-190"><a href="#Jobs-190"><span class="linenos">190</span></a>    <span class="c1">#set  &quot;project_id&quot;  based on config, env, or argv in that order.</span>
</span><span id="Jobs-191"><a href="#Jobs-191"><span class="linenos">191</span></a>  
</span><span id="Jobs-192"><a href="#Jobs-192"><span class="linenos">192</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]:</span> 
</span><span id="Jobs-193"><a href="#Jobs-193"><span class="linenos">193</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]</span> 
</span><span id="Jobs-194"><a href="#Jobs-194"><span class="linenos">194</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">):</span> 
</span><span id="Jobs-195"><a href="#Jobs-195"><span class="linenos">195</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">)</span> 
</span><span id="Jobs-196"><a href="#Jobs-196"><span class="linenos">196</span></a>    <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span><span class="p">:</span>
</span><span id="Jobs-197"><a href="#Jobs-197"><span class="linenos">197</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span>
</span><span id="Jobs-198"><a href="#Jobs-198"><span class="linenos">198</span></a>
</span><span id="Jobs-199"><a href="#Jobs-199"><span class="linenos">199</span></a>  <span class="k">def</span> <span class="nf">_create_runnable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="p">:</span>
</span><span id="Jobs-200"><a href="#Jobs-200"><span class="linenos">200</span></a>
</span><span id="Jobs-201"><a href="#Jobs-201"><span class="linenos">201</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="p">()</span>
</span><span id="Jobs-202"><a href="#Jobs-202"><span class="linenos">202</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
</span><span id="Jobs-203"><a href="#Jobs-203"><span class="linenos">203</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;variables&quot;</span><span class="p">:{</span><span class="s2">&quot;JOB_ID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">}}</span>
</span><span id="Jobs-204"><a href="#Jobs-204"><span class="linenos">204</span></a>
</span><span id="Jobs-205"><a href="#Jobs-205"><span class="linenos">205</span></a>    <span class="k">if</span> <span class="s2">&quot;container&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-206"><a href="#Jobs-206"><span class="linenos">206</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="o">.</span><span class="n">Container</span><span class="p">()</span>
</span><span id="Jobs-207"><a href="#Jobs-207"><span class="linenos">207</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">image_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="s2">&quot;image_uri&quot;</span><span class="p">]</span> 
</span><span id="Jobs-208"><a href="#Jobs-208"><span class="linenos">208</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">entrypoint</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="s2">&quot;entry_point&quot;</span><span class="p">]</span> 
</span><span id="Jobs-209"><a href="#Jobs-209"><span class="linenos">209</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span> 
</span><span id="Jobs-210"><a href="#Jobs-210"><span class="linenos">210</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="s2">&quot;--privileged&quot;</span>
</span><span id="Jobs-211"><a href="#Jobs-211"><span class="linenos">211</span></a>      <span class="k">if</span> <span class="s2">&quot;install_gpu_drivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-212"><a href="#Jobs-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/var/lib/nvidia/lib64:/usr/local/nvidia/lib64&quot;</span><span class="p">)</span>
</span><span id="Jobs-213"><a href="#Jobs-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/var/lib/nvidia/bin:/usr/local/nvidia/bin&quot;</span><span class="p">)</span>
</span><span id="Jobs-214"><a href="#Jobs-214"><span class="linenos">214</span></a>
</span><span id="Jobs-215"><a href="#Jobs-215"><span class="linenos">215</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Jobs-216"><a href="#Jobs-216"><span class="linenos">216</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Runnable</span><span class="o">.</span><span class="n">Script</span><span class="p">()</span>
</span><span id="Jobs-217"><a href="#Jobs-217"><span class="linenos">217</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;script_text&quot;</span><span class="p">]</span>
</span><span id="Jobs-218"><a href="#Jobs-218"><span class="linenos">218</span></a>    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="p">)</span>
</span><span id="Jobs-219"><a href="#Jobs-219"><span class="linenos">219</span></a>
</span><span id="Jobs-220"><a href="#Jobs-220"><span class="linenos">220</span></a>    
</span><span id="Jobs-221"><a href="#Jobs-221"><span class="linenos">221</span></a>  <span class="k">def</span> <span class="nf">_create_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">TaskSpec</span><span class="p">:</span>
</span><span id="Jobs-222"><a href="#Jobs-222"><span class="linenos">222</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Jobs-223"><a href="#Jobs-223"><span class="linenos">223</span></a><span class="sd">    _summary_</span>
</span><span id="Jobs-224"><a href="#Jobs-224"><span class="linenos">224</span></a>
</span><span id="Jobs-225"><a href="#Jobs-225"><span class="linenos">225</span></a><span class="sd">    :return: _description_</span>
</span><span id="Jobs-226"><a href="#Jobs-226"><span class="linenos">226</span></a><span class="sd">    :rtype: batch_v1.TaskSpec</span>
</span><span id="Jobs-227"><a href="#Jobs-227"><span class="linenos">227</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Jobs-228"><a href="#Jobs-228"><span class="linenos">228</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">TaskSpec</span><span class="p">()</span>
</span><span id="Jobs-229"><a href="#Jobs-229"><span class="linenos">229</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">max_retry_count</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="Jobs-230"><a href="#Jobs-230"><span class="linenos">230</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">max_run_duration</span> <span class="o">=</span> <span class="s2">&quot;604800s&quot;</span>
</span><span id="Jobs-231"><a href="#Jobs-231"><span class="linenos">231</span></a>
</span><span id="Jobs-232"><a href="#Jobs-232"><span class="linenos">232</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Jobs-233"><a href="#Jobs-233"><span class="linenos">233</span></a>
</span><span id="Jobs-234"><a href="#Jobs-234"><span class="linenos">234</span></a>    <span class="k">if</span> <span class="s2">&quot;nfs_server&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-235"><a href="#Jobs-235"><span class="linenos">235</span></a>
</span><span id="Jobs-236"><a href="#Jobs-236"><span class="linenos">236</span></a>      <span class="n">nfs_server</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">NFS</span><span class="p">()</span>
</span><span id="Jobs-237"><a href="#Jobs-237"><span class="linenos">237</span></a>      <span class="n">nfs_server</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nfs_server&quot;</span><span class="p">]</span>
</span><span id="Jobs-238"><a href="#Jobs-238"><span class="linenos">238</span></a>      <span class="n">nfs_server</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nfs_remote_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;nfs_remote_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;/nfshare&quot;</span>
</span><span id="Jobs-239"><a href="#Jobs-239"><span class="linenos">239</span></a>
</span><span id="Jobs-240"><a href="#Jobs-240"><span class="linenos">240</span></a>      <span class="n">nfs_volume</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Volume</span><span class="p">()</span>
</span><span id="Jobs-241"><a href="#Jobs-241"><span class="linenos">241</span></a>      <span class="n">nfs_volume</span><span class="o">.</span><span class="n">nfs</span> <span class="o">=</span> <span class="n">nfs_server</span>
</span><span id="Jobs-242"><a href="#Jobs-242"><span class="linenos">242</span></a>      <span class="n">nfs_volume</span><span class="o">.</span><span class="n">mount_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nfs_path&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;nfs_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s2">&quot;/mnt/nfs&quot;</span>
</span><span id="Jobs-243"><a href="#Jobs-243"><span class="linenos">243</span></a>
</span><span id="Jobs-244"><a href="#Jobs-244"><span class="linenos">244</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nfs_volume</span><span class="p">)</span>
</span><span id="Jobs-245"><a href="#Jobs-245"><span class="linenos">245</span></a>
</span><span id="Jobs-246"><a href="#Jobs-246"><span class="linenos">246</span></a>
</span><span id="Jobs-247"><a href="#Jobs-247"><span class="linenos">247</span></a><span class="c1"># Use commmand line flags first, then config file, to set</span>
</span><span id="Jobs-248"><a href="#Jobs-248"><span class="linenos">248</span></a><span class="c1"># gcs bucket mounts</span>
</span><span id="Jobs-249"><a href="#Jobs-249"><span class="linenos">249</span></a>    <span class="k">if</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">volumes</span><span class="p">):</span>
</span><span id="Jobs-250"><a href="#Jobs-250"><span class="linenos">250</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Jobs-251"><a href="#Jobs-251"><span class="linenos">251</span></a>      <span class="k">for</span> <span class="n">volume_pair</span> <span class="ow">in</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">volumes</span><span class="p">:</span>
</span><span id="Jobs-252"><a href="#Jobs-252"><span class="linenos">252</span></a>        <span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">gcs_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">volume_pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="Jobs-253"><a href="#Jobs-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;bucket_name&quot;</span><span class="p">:</span><span class="n">bucket_name</span><span class="p">,</span> <span class="s2">&quot;gcs_path&quot;</span><span class="p">:</span><span class="n">gcs_path</span><span class="p">})</span>
</span><span id="Jobs-254"><a href="#Jobs-254"><span class="linenos">254</span></a>    <span class="k">elif</span> <span class="s2">&quot;volumes&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-255"><a href="#Jobs-255"><span class="linenos">255</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;volumes&quot;</span><span class="p">]</span>
</span><span id="Jobs-256"><a href="#Jobs-256"><span class="linenos">256</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Jobs-257"><a href="#Jobs-257"><span class="linenos">257</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Jobs-258"><a href="#Jobs-258"><span class="linenos">258</span></a>      
</span><span id="Jobs-259"><a href="#Jobs-259"><span class="linenos">259</span></a>
</span><span id="Jobs-260"><a href="#Jobs-260"><span class="linenos">260</span></a>    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Jobs-261"><a href="#Jobs-261"><span class="linenos">261</span></a>      <span class="n">gcs_volume</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Volume</span><span class="p">()</span>
</span><span id="Jobs-262"><a href="#Jobs-262"><span class="linenos">262</span></a>      <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">:</span>
</span><span id="Jobs-263"><a href="#Jobs-263"><span class="linenos">263</span></a>        <span class="n">gcs_bucket</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">GCS</span><span class="p">()</span>
</span><span id="Jobs-264"><a href="#Jobs-264"><span class="linenos">264</span></a>        <span class="n">gcs_bucket</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="n">volume</span><span class="p">[</span><span class="s2">&quot;bucket_name&quot;</span><span class="p">]</span>
</span><span id="Jobs-265"><a href="#Jobs-265"><span class="linenos">265</span></a>        <span class="n">gcs_volume</span><span class="o">.</span><span class="n">mount_path</span> <span class="o">=</span> <span class="n">volume</span><span class="p">[</span><span class="s2">&quot;gcs_path&quot;</span><span class="p">]</span>
</span><span id="Jobs-266"><a href="#Jobs-266"><span class="linenos">266</span></a>        <span class="n">gcs_volume</span><span class="o">.</span><span class="n">gcs</span> <span class="o">=</span> <span class="n">gcs_bucket</span>
</span><span id="Jobs-267"><a href="#Jobs-267"><span class="linenos">267</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gcs_volume</span><span class="p">)</span>
</span><span id="Jobs-268"><a href="#Jobs-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="s2">&quot;container&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-269"><a href="#Jobs-269"><span class="linenos">269</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="Jobs-270"><a href="#Jobs-270"><span class="linenos">270</span></a>            <span class="n">volume</span><span class="p">[</span><span class="s2">&quot;gcs_path&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="n">volume</span><span class="p">[</span><span class="s2">&quot;gcs_path&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;:rw&quot;</span><span class="p">)</span>
</span><span id="Jobs-271"><a href="#Jobs-271"><span class="linenos">271</span></a>
</span><span id="Jobs-272"><a href="#Jobs-272"><span class="linenos">272</span></a>  <span class="c1"># We can specify what resources are requoested by each task.</span>
</span><span id="Jobs-273"><a href="#Jobs-273"><span class="linenos">273</span></a>
</span><span id="Jobs-274"><a href="#Jobs-274"><span class="linenos">274</span></a>    <span class="n">resources</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">ComputeResource</span><span class="p">()</span>
</span><span id="Jobs-275"><a href="#Jobs-275"><span class="linenos">275</span></a>    <span class="n">resources</span><span class="o">.</span><span class="n">cpu_milli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cpu_milli&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;cpu_milli&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1000</span> 
</span><span id="Jobs-276"><a href="#Jobs-276"><span class="linenos">276</span></a>    <span class="n">resources</span><span class="o">.</span><span class="n">memory_mib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;memory_mib&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;memory_mib&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">102400</span>
</span><span id="Jobs-277"><a href="#Jobs-277"><span class="linenos">277</span></a>    <span class="n">resources</span><span class="o">.</span><span class="n">boot_disk_mib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;boot_disk_mib&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;boot_disk_mib&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">102400</span>
</span><span id="Jobs-278"><a href="#Jobs-278"><span class="linenos">278</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">compute_resource</span> <span class="o">=</span> <span class="n">resources</span>
</span><span id="Jobs-279"><a href="#Jobs-279"><span class="linenos">279</span></a>
</span><span id="Jobs-280"><a href="#Jobs-280"><span class="linenos">280</span></a>    <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
</span><span id="Jobs-281"><a href="#Jobs-281"><span class="linenos">281</span></a>
</span><span id="Jobs-282"><a href="#Jobs-282"><span class="linenos">282</span></a>    
</span><span id="Jobs-283"><a href="#Jobs-283"><span class="linenos">283</span></a>  <span class="k">def</span> <span class="nf">_create_allocation_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="p">:</span>
</span><span id="Jobs-284"><a href="#Jobs-284"><span class="linenos">284</span></a>
</span><span id="Jobs-285"><a href="#Jobs-285"><span class="linenos">285</span></a>      <span class="c1"># Policies are used to define on what kind of virtual machines the tasks will run on.</span>
</span><span id="Jobs-286"><a href="#Jobs-286"><span class="linenos">286</span></a>      <span class="c1"># In this case, we tell the system to use an instance template that defines all the</span>
</span><span id="Jobs-287"><a href="#Jobs-287"><span class="linenos">287</span></a>      <span class="c1"># required parameters.</span>
</span><span id="Jobs-288"><a href="#Jobs-288"><span class="linenos">288</span></a>
</span><span id="Jobs-289"><a href="#Jobs-289"><span class="linenos">289</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="p">()</span>
</span><span id="Jobs-290"><a href="#Jobs-290"><span class="linenos">290</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">InstancePolicyOrTemplate</span><span class="p">()</span>
</span><span id="Jobs-291"><a href="#Jobs-291"><span class="linenos">291</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">InstancePolicy</span><span class="p">()</span>
</span><span id="Jobs-292"><a href="#Jobs-292"><span class="linenos">292</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">Accelerator</span><span class="p">()</span>
</span><span id="Jobs-293"><a href="#Jobs-293"><span class="linenos">293</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">network_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">NetworkPolicy</span><span class="p">()</span>
</span><span id="Jobs-294"><a href="#Jobs-294"><span class="linenos">294</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">NetworkInterface</span><span class="p">()</span>
</span><span id="Jobs-295"><a href="#Jobs-295"><span class="linenos">295</span></a>
</span><span id="Jobs-296"><a href="#Jobs-296"><span class="linenos">296</span></a>      <span class="k">if</span> <span class="s2">&quot;template_link&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-297"><a href="#Jobs-297"><span class="linenos">297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">instance_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;template_link&quot;</span><span class="p">]</span>
</span><span id="Jobs-298"><a href="#Jobs-298"><span class="linenos">298</span></a>      <span class="k">elif</span> <span class="s2">&quot;machine_type&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-299"><a href="#Jobs-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span><span class="o">.</span><span class="n">machine_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;machine_type&quot;</span><span class="p">]</span>
</span><span id="Jobs-300"><a href="#Jobs-300"><span class="linenos">300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span>
</span><span id="Jobs-301"><a href="#Jobs-301"><span class="linenos">301</span></a>
</span><span id="Jobs-302"><a href="#Jobs-302"><span class="linenos">302</span></a>        <span class="k">if</span> <span class="s2">&quot;accelerator&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-303"><a href="#Jobs-303"><span class="linenos">303</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">type_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;accelerator&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="Jobs-304"><a href="#Jobs-304"><span class="linenos">304</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;accelerator&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
</span><span id="Jobs-305"><a href="#Jobs-305"><span class="linenos">305</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span><span class="o">.</span><span class="n">accelerators</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="p">]</span>
</span><span id="Jobs-306"><a href="#Jobs-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="s2">&quot;install_gpu_drivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-307"><a href="#Jobs-307"><span class="linenos">307</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">install_gpu_drivers</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Jobs-308"><a href="#Jobs-308"><span class="linenos">308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_policy</span>
</span><span id="Jobs-309"><a href="#Jobs-309"><span class="linenos">309</span></a>          
</span><span id="Jobs-310"><a href="#Jobs-310"><span class="linenos">310</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="Jobs-311"><a href="#Jobs-311"><span class="linenos">311</span></a>        <span class="k">raise</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No instance policy defined.&quot;</span><span class="p">))</span>
</span><span id="Jobs-312"><a href="#Jobs-312"><span class="linenos">312</span></a>
</span><span id="Jobs-313"><a href="#Jobs-313"><span class="linenos">313</span></a>      <span class="n">location_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">AllocationPolicy</span><span class="o">.</span><span class="n">LocationPolicy</span><span class="p">()</span>
</span><span id="Jobs-314"><a href="#Jobs-314"><span class="linenos">314</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">]</span>
</span><span id="Jobs-315"><a href="#Jobs-315"><span class="linenos">315</span></a>
</span><span id="Jobs-316"><a href="#Jobs-316"><span class="linenos">316</span></a>      <span class="k">if</span> <span class="s2">&quot;network&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-317"><a href="#Jobs-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="s2">&quot;no_external_ip_address&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-318"><a href="#Jobs-318"><span class="linenos">318</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">no_external_ip_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;no_external_ip_address&quot;</span><span class="p">]</span>
</span><span id="Jobs-319"><a href="#Jobs-319"><span class="linenos">319</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">subnetwork</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;regions/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s1">/subnetworks/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subnetwork&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Jobs-320"><a href="#Jobs-320"><span class="linenos">320</span></a>          
</span><span id="Jobs-321"><a href="#Jobs-321"><span class="linenos">321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;projects/</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="w"> </span><span class="si">}</span><span class="s1">/global/networks/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Jobs-322"><a href="#Jobs-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network_policy</span><span class="o">.</span><span class="n">network_interfaces</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]</span>
</span><span id="Jobs-323"><a href="#Jobs-323"><span class="linenos">323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_policy</span>
</span><span id="Jobs-324"><a href="#Jobs-324"><span class="linenos">324</span></a>
</span><span id="Jobs-325"><a href="#Jobs-325"><span class="linenos">325</span></a>      <span class="k">if</span> <span class="s2">&quot;allowed_locations&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Jobs-326"><a href="#Jobs-326"><span class="linenos">326</span></a>        <span class="n">location_policy</span><span class="o">.</span><span class="n">allowed_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;allowed_locations&quot;</span><span class="p">]</span>
</span><span id="Jobs-327"><a href="#Jobs-327"><span class="linenos">327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location_policy</span>
</span><span id="Jobs-328"><a href="#Jobs-328"><span class="linenos">328</span></a>
</span><span id="Jobs-329"><a href="#Jobs-329"><span class="linenos">329</span></a>      <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span><span class="p">)</span>
</span><span id="Jobs-330"><a href="#Jobs-330"><span class="linenos">330</span></a>    
</span><span id="Jobs-331"><a href="#Jobs-331"><span class="linenos">331</span></a>  <span class="k">def</span> <span class="nf">_create_taskgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Jobs-332"><a href="#Jobs-332"><span class="linenos">332</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="Jobs-333"><a href="#Jobs-333"><span class="linenos">333</span></a><span class="sd">        Tasks are grouped inside a job using TaskGroups.</span>
</span><span id="Jobs-334"><a href="#Jobs-334"><span class="linenos">334</span></a><span class="sd">        Currently, it&#39;s possible to have only one task group.</span>
</span><span id="Jobs-335"><a href="#Jobs-335"><span class="linenos">335</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="Jobs-336"><a href="#Jobs-336"><span class="linenos">336</span></a>
</span><span id="Jobs-337"><a href="#Jobs-337"><span class="linenos">337</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span>
</span><span id="Jobs-338"><a href="#Jobs-338"><span class="linenos">338</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">task_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>
</span><span id="Jobs-339"><a href="#Jobs-339"><span class="linenos">339</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">task_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task_count&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;task_count&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="Jobs-340"><a href="#Jobs-340"><span class="linenos">340</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">parallelism</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;parallelism&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;parallelism&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="Jobs-341"><a href="#Jobs-341"><span class="linenos">341</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">task_count_per_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;task_count_per_node&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;task_count_per_node&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="Jobs-342"><a href="#Jobs-342"><span class="linenos">342</span></a>
</span><span id="Jobs-343"><a href="#Jobs-343"><span class="linenos">343</span></a>      <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
</span><span id="Jobs-344"><a href="#Jobs-344"><span class="linenos">344</span></a>
</span><span id="Jobs-345"><a href="#Jobs-345"><span class="linenos">345</span></a>  <span class="k">def</span> <span class="nf">create_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Jobs-346"><a href="#Jobs-346"><span class="linenos">346</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;Creates job after configuration is completed. </span>
</span><span id="Jobs-347"><a href="#Jobs-347"><span class="linenos">347</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="Jobs-348"><a href="#Jobs-348"><span class="linenos">348</span></a>
</span><span id="Jobs-349"><a href="#Jobs-349"><span class="linenos">349</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">()</span>
</span><span id="Jobs-350"><a href="#Jobs-350"><span class="linenos">350</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;hpc&quot;</span><span class="p">}</span>
</span><span id="Jobs-351"><a href="#Jobs-351"><span class="linenos">351</span></a>
</span><span id="Jobs-352"><a href="#Jobs-352"><span class="linenos">352</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">task_groups</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
</span><span id="Jobs-353"><a href="#Jobs-353"><span class="linenos">353</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">allocation_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span>
</span><span id="Jobs-354"><a href="#Jobs-354"><span class="linenos">354</span></a>
</span><span id="Jobs-355"><a href="#Jobs-355"><span class="linenos">355</span></a>      <span class="c1"># We use Cloud Logging as it&#39;s an out of the box available option</span>
</span><span id="Jobs-356"><a href="#Jobs-356"><span class="linenos">356</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">logs_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">LogsPolicy</span><span class="p">()</span>
</span><span id="Jobs-357"><a href="#Jobs-357"><span class="linenos">357</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">logs_policy</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">LogsPolicy</span><span class="o">.</span><span class="n">Destination</span><span class="o">.</span><span class="n">CLOUD_LOGGING</span>
</span><span id="Jobs-358"><a href="#Jobs-358"><span class="linenos">358</span></a>      <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
</span><span id="Jobs-359"><a href="#Jobs-359"><span class="linenos">359</span></a>    
</span><span id="Jobs-360"><a href="#Jobs-360"><span class="linenos">360</span></a>  <span class="k">def</span> <span class="nf">_create_job_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">:</span>
</span><span id="Jobs-361"><a href="#Jobs-361"><span class="linenos">361</span></a>
</span><span id="Jobs-362"><a href="#Jobs-362"><span class="linenos">362</span></a>      <span class="c1"># Define what will be done as part of the job.</span>
</span><span id="Jobs-363"><a href="#Jobs-363"><span class="linenos">363</span></a>
</span><span id="Jobs-364"><a href="#Jobs-364"><span class="linenos">364</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_runnable</span><span class="p">()</span>
</span><span id="Jobs-365"><a href="#Jobs-365"><span class="linenos">365</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">()</span>
</span><span id="Jobs-366"><a href="#Jobs-366"><span class="linenos">366</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">runnables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">runnable</span><span class="p">]</span>
</span><span id="Jobs-367"><a href="#Jobs-367"><span class="linenos">367</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_taskgroup</span><span class="p">()</span>
</span><span id="Jobs-368"><a href="#Jobs-368"><span class="linenos">368</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_create_allocation_policy</span><span class="p">()</span>
</span><span id="Jobs-369"><a href="#Jobs-369"><span class="linenos">369</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">create_job</span><span class="p">()</span>
</span><span id="Jobs-370"><a href="#Jobs-370"><span class="linenos">370</span></a>
</span><span id="Jobs-371"><a href="#Jobs-371"><span class="linenos">371</span></a>      <span class="n">create_request</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">CreateJobRequest</span><span class="p">()</span>
</span><span id="Jobs-372"><a href="#Jobs-372"><span class="linenos">372</span></a>      <span class="n">create_request</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span>
</span><span id="Jobs-373"><a href="#Jobs-373"><span class="linenos">373</span></a>      <span class="n">create_request</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
</span><span id="Jobs-374"><a href="#Jobs-374"><span class="linenos">374</span></a>      
</span><span id="Jobs-375"><a href="#Jobs-375"><span class="linenos">375</span></a>      <span class="c1"># The job&#39;s parent is the region in which the job will run</span>
</span><span id="Jobs-376"><a href="#Jobs-376"><span class="linenos">376</span></a>      <span class="n">create_request</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;projects/</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="w"> </span><span class="si">}</span><span class="s1">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Jobs-377"><a href="#Jobs-377"><span class="linenos">377</span></a>
</span><span id="Jobs-378"><a href="#Jobs-378"><span class="linenos">378</span></a>      <span class="k">return</span><span class="p">(</span><span class="n">create_request</span><span class="p">)</span>
</span><span id="Jobs-379"><a href="#Jobs-379"><span class="linenos">379</span></a>  <span class="c1"># [END batch_create_job_with_template]</span>
</span><span id="Jobs-380"><a href="#Jobs-380"><span class="linenos">380</span></a>
</span><span id="Jobs-381"><a href="#Jobs-381"><span class="linenos">381</span></a>  <span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete_job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Operation</span><span class="p">:</span>
</span><span id="Jobs-382"><a href="#Jobs-382"><span class="linenos">382</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Jobs-383"><a href="#Jobs-383"><span class="linenos">383</span></a><span class="sd">      Triggers the deletion of a Job.</span>
</span><span id="Jobs-384"><a href="#Jobs-384"><span class="linenos">384</span></a>
</span><span id="Jobs-385"><a href="#Jobs-385"><span class="linenos">385</span></a><span class="sd">      Args:</span>
</span><span id="Jobs-386"><a href="#Jobs-386"><span class="linenos">386</span></a><span class="sd">        delete_job: name of the job to delete</span>
</span><span id="Jobs-387"><a href="#Jobs-387"><span class="linenos">387</span></a>
</span><span id="Jobs-388"><a href="#Jobs-388"><span class="linenos">388</span></a><span class="sd">      Returns:</span>
</span><span id="Jobs-389"><a href="#Jobs-389"><span class="linenos">389</span></a><span class="sd">          An operation object related to the deletion. You can call `.result()`</span>
</span><span id="Jobs-390"><a href="#Jobs-390"><span class="linenos">390</span></a><span class="sd">          on it to wait for its completion.</span>
</span><span id="Jobs-391"><a href="#Jobs-391"><span class="linenos">391</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="Jobs-392"><a href="#Jobs-392"><span class="linenos">392</span></a>      <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="Jobs-393"><a href="#Jobs-393"><span class="linenos">393</span></a>
</span><span id="Jobs-394"><a href="#Jobs-394"><span class="linenos">394</span></a>      <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/jobs/</span><span class="si">{</span><span class="n">delete_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Jobs-395"><a href="#Jobs-395"><span class="linenos">395</span></a>
</span><span id="Jobs-396"><a href="#Jobs-396"><span class="linenos">396</span></a>  <span class="k">def</span> <span class="nf">list_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">]:</span>
</span><span id="Jobs-397"><a href="#Jobs-397"><span class="linenos">397</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Jobs-398"><a href="#Jobs-398"><span class="linenos">398</span></a><span class="sd">      Get a list of all jobs defined in given region.</span>
</span><span id="Jobs-399"><a href="#Jobs-399"><span class="linenos">399</span></a>
</span><span id="Jobs-400"><a href="#Jobs-400"><span class="linenos">400</span></a><span class="sd">      Returns:</span>
</span><span id="Jobs-401"><a href="#Jobs-401"><span class="linenos">401</span></a><span class="sd">          An iterable collection of Job object.</span>
</span><span id="Jobs-402"><a href="#Jobs-402"><span class="linenos">402</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="Jobs-403"><a href="#Jobs-403"><span class="linenos">403</span></a>      <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="Jobs-404"><a href="#Jobs-404"><span class="linenos">404</span></a>
</span><span id="Jobs-405"><a href="#Jobs-405"><span class="linenos">405</span></a>      <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            <div id="Jobs.__init__" class="classattr">
                                        <input id="Jobs.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Jobs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">config</span></span>)</span>

                <label class="view-source-button" for="Jobs.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Jobs.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Jobs.__init__-176"><a href="#Jobs.__init__-176"><span class="linenos">176</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Jobs.__init__-177"><a href="#Jobs.__init__-177"><span class="linenos">177</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Jobs.__init__-178"><a href="#Jobs.__init__-178"><span class="linenos">178</span></a><span class="sd">    Class to create all cloud resources for Batch Jobs</span>
</span><span id="Jobs.__init__-179"><a href="#Jobs.__init__-179"><span class="linenos">179</span></a>
</span><span id="Jobs.__init__-180"><a href="#Jobs.__init__-180"><span class="linenos">180</span></a><span class="sd">    Args:</span>
</span><span id="Jobs.__init__-181"><a href="#Jobs.__init__-181"><span class="linenos">181</span></a><span class="sd">      job_id: an arbitrary string to name the job.</span>
</span><span id="Jobs.__init__-182"><a href="#Jobs.__init__-182"><span class="linenos">182</span></a><span class="sd">      config: data structure from YAML to represent everything in the config file.</span>
</span><span id="Jobs.__init__-183"><a href="#Jobs.__init__-183"><span class="linenos">183</span></a>
</span><span id="Jobs.__init__-184"><a href="#Jobs.__init__-184"><span class="linenos">184</span></a><span class="sd">    Returns:</span>
</span><span id="Jobs.__init__-185"><a href="#Jobs.__init__-185"><span class="linenos">185</span></a><span class="sd">      None</span>
</span><span id="Jobs.__init__-186"><a href="#Jobs.__init__-186"><span class="linenos">186</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Jobs.__init__-187"><a href="#Jobs.__init__-187"><span class="linenos">187</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="Jobs.__init__-188"><a href="#Jobs.__init__-188"><span class="linenos">188</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
</span><span id="Jobs.__init__-189"><a href="#Jobs.__init__-189"><span class="linenos">189</span></a>    
</span><span id="Jobs.__init__-190"><a href="#Jobs.__init__-190"><span class="linenos">190</span></a>    <span class="c1">#set  &quot;project_id&quot;  based on config, env, or argv in that order.</span>
</span><span id="Jobs.__init__-191"><a href="#Jobs.__init__-191"><span class="linenos">191</span></a>  
</span><span id="Jobs.__init__-192"><a href="#Jobs.__init__-192"><span class="linenos">192</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]:</span> 
</span><span id="Jobs.__init__-193"><a href="#Jobs.__init__-193"><span class="linenos">193</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_id&quot;</span><span class="p">]</span> 
</span><span id="Jobs.__init__-194"><a href="#Jobs.__init__-194"><span class="linenos">194</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">):</span> 
</span><span id="Jobs.__init__-195"><a href="#Jobs.__init__-195"><span class="linenos">195</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_CLOUD_PROJECT&#39;</span><span class="p">)</span> 
</span><span id="Jobs.__init__-196"><a href="#Jobs.__init__-196"><span class="linenos">196</span></a>    <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span><span class="p">:</span>
</span><span id="Jobs.__init__-197"><a href="#Jobs.__init__-197"><span class="linenos">197</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">project_id</span>
</span></pre></div>


            <div class="docstring"><p>Class to create all cloud resources for Batch Jobs</p>

<p>Args:
  job_id: an arbitrary string to name the job.
  config: data structure from YAML to represent everything in the config file.</p>

<p>Returns:
  None</p>
</div>


                            </div>
                            <div id="Jobs.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span>

        
    </div>
    <a class="headerlink" href="#Jobs.config"></a>
    
    

                            </div>
                            <div id="Jobs.job_id" class="classattr">
                                <div class="attr variable">
            <span class="name">job_id</span>

        
    </div>
    <a class="headerlink" href="#Jobs.job_id"></a>
    
    

                            </div>
                            <div id="Jobs.create_job" class="classattr">
                                        <input id="Jobs.create_job-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_job</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Jobs.create_job-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Jobs.create_job"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Jobs.create_job-345"><a href="#Jobs.create_job-345"><span class="linenos">345</span></a>  <span class="k">def</span> <span class="nf">create_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Jobs.create_job-346"><a href="#Jobs.create_job-346"><span class="linenos">346</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;Creates job after configuration is completed. </span>
</span><span id="Jobs.create_job-347"><a href="#Jobs.create_job-347"><span class="linenos">347</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="Jobs.create_job-348"><a href="#Jobs.create_job-348"><span class="linenos">348</span></a>
</span><span id="Jobs.create_job-349"><a href="#Jobs.create_job-349"><span class="linenos">349</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">()</span>
</span><span id="Jobs.create_job-350"><a href="#Jobs.create_job-350"><span class="linenos">350</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;hpc&quot;</span><span class="p">}</span>
</span><span id="Jobs.create_job-351"><a href="#Jobs.create_job-351"><span class="linenos">351</span></a>
</span><span id="Jobs.create_job-352"><a href="#Jobs.create_job-352"><span class="linenos">352</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">task_groups</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
</span><span id="Jobs.create_job-353"><a href="#Jobs.create_job-353"><span class="linenos">353</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">allocation_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_policy</span>
</span><span id="Jobs.create_job-354"><a href="#Jobs.create_job-354"><span class="linenos">354</span></a>
</span><span id="Jobs.create_job-355"><a href="#Jobs.create_job-355"><span class="linenos">355</span></a>      <span class="c1"># We use Cloud Logging as it&#39;s an out of the box available option</span>
</span><span id="Jobs.create_job-356"><a href="#Jobs.create_job-356"><span class="linenos">356</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">logs_policy</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">LogsPolicy</span><span class="p">()</span>
</span><span id="Jobs.create_job-357"><a href="#Jobs.create_job-357"><span class="linenos">357</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">logs_policy</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">LogsPolicy</span><span class="o">.</span><span class="n">Destination</span><span class="o">.</span><span class="n">CLOUD_LOGGING</span>
</span><span id="Jobs.create_job-358"><a href="#Jobs.create_job-358"><span class="linenos">358</span></a>      <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates job after configuration is completed.</p>
</div>


                            </div>
                            <div id="Jobs.delete_job" class="classattr">
                                        <input id="Jobs.delete_job-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_job</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">delete_job</span></span><span class="return-annotation">) -> <span class="n">google</span><span class="o">.</span><span class="n">api_core</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">Operation</span>:</span></span>

                <label class="view-source-button" for="Jobs.delete_job-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Jobs.delete_job"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Jobs.delete_job-381"><a href="#Jobs.delete_job-381"><span class="linenos">381</span></a>  <span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete_job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Operation</span><span class="p">:</span>
</span><span id="Jobs.delete_job-382"><a href="#Jobs.delete_job-382"><span class="linenos">382</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Jobs.delete_job-383"><a href="#Jobs.delete_job-383"><span class="linenos">383</span></a><span class="sd">      Triggers the deletion of a Job.</span>
</span><span id="Jobs.delete_job-384"><a href="#Jobs.delete_job-384"><span class="linenos">384</span></a>
</span><span id="Jobs.delete_job-385"><a href="#Jobs.delete_job-385"><span class="linenos">385</span></a><span class="sd">      Args:</span>
</span><span id="Jobs.delete_job-386"><a href="#Jobs.delete_job-386"><span class="linenos">386</span></a><span class="sd">        delete_job: name of the job to delete</span>
</span><span id="Jobs.delete_job-387"><a href="#Jobs.delete_job-387"><span class="linenos">387</span></a>
</span><span id="Jobs.delete_job-388"><a href="#Jobs.delete_job-388"><span class="linenos">388</span></a><span class="sd">      Returns:</span>
</span><span id="Jobs.delete_job-389"><a href="#Jobs.delete_job-389"><span class="linenos">389</span></a><span class="sd">          An operation object related to the deletion. You can call `.result()`</span>
</span><span id="Jobs.delete_job-390"><a href="#Jobs.delete_job-390"><span class="linenos">390</span></a><span class="sd">          on it to wait for its completion.</span>
</span><span id="Jobs.delete_job-391"><a href="#Jobs.delete_job-391"><span class="linenos">391</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="Jobs.delete_job-392"><a href="#Jobs.delete_job-392"><span class="linenos">392</span></a>      <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="Jobs.delete_job-393"><a href="#Jobs.delete_job-393"><span class="linenos">393</span></a>
</span><span id="Jobs.delete_job-394"><a href="#Jobs.delete_job-394"><span class="linenos">394</span></a>      <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/jobs/</span><span class="si">{</span><span class="n">delete_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Triggers the deletion of a Job.</p>

<p>Args:
  delete_job: name of the job to delete</p>

<p>Returns:
    An operation object related to the deletion. You can call <code>.result()</code>
    on it to wait for its completion.</p>
</div>


                            </div>
                            <div id="Jobs.list_jobs" class="classattr">
                                        <input id="Jobs.list_jobs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_jobs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Iterable</span><span class="p">[</span><span class="n">google</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">batch_v1</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">Job</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Jobs.list_jobs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Jobs.list_jobs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Jobs.list_jobs-396"><a href="#Jobs.list_jobs-396"><span class="linenos">396</span></a>  <span class="k">def</span> <span class="nf">list_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">batch_v1</span><span class="o">.</span><span class="n">Job</span><span class="p">]:</span>
</span><span id="Jobs.list_jobs-397"><a href="#Jobs.list_jobs-397"><span class="linenos">397</span></a><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Jobs.list_jobs-398"><a href="#Jobs.list_jobs-398"><span class="linenos">398</span></a><span class="sd">      Get a list of all jobs defined in given region.</span>
</span><span id="Jobs.list_jobs-399"><a href="#Jobs.list_jobs-399"><span class="linenos">399</span></a>
</span><span id="Jobs.list_jobs-400"><a href="#Jobs.list_jobs-400"><span class="linenos">400</span></a><span class="sd">      Returns:</span>
</span><span id="Jobs.list_jobs-401"><a href="#Jobs.list_jobs-401"><span class="linenos">401</span></a><span class="sd">          An iterable collection of Job object.</span>
</span><span id="Jobs.list_jobs-402"><a href="#Jobs.list_jobs-402"><span class="linenos">402</span></a><span class="sd">      &quot;&quot;&quot;</span>
</span><span id="Jobs.list_jobs-403"><a href="#Jobs.list_jobs-403"><span class="linenos">403</span></a>      <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="Jobs.list_jobs-404"><a href="#Jobs.list_jobs-404"><span class="linenos">404</span></a>
</span><span id="Jobs.list_jobs-405"><a href="#Jobs.list_jobs-405"><span class="linenos">405</span></a>      <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="si">}</span><span class="s2">/locations/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a list of all jobs defined in given region.</p>

<p>Returns:
    An iterable collection of Job object.</p>
</div>


                            </div>
                </section>
                <section id="parse_yaml_file">
                            <input id="parse_yaml_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_yaml_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="parse_yaml_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#parse_yaml_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="parse_yaml_file-409"><a href="#parse_yaml_file-409"><span class="linenos">409</span></a><span class="k">def</span> <span class="nf">parse_yaml_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="parse_yaml_file-410"><a href="#parse_yaml_file-410"><span class="linenos">410</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="parse_yaml_file-411"><a href="#parse_yaml_file-411"><span class="linenos">411</span></a><span class="sd">  Parse the provided YAML file to get the job configuration</span>
</span><span id="parse_yaml_file-412"><a href="#parse_yaml_file-412"><span class="linenos">412</span></a>
</span><span id="parse_yaml_file-413"><a href="#parse_yaml_file-413"><span class="linenos">413</span></a><span class="sd">  :param file_name: The path to the YAML configuration file</span>
</span><span id="parse_yaml_file-414"><a href="#parse_yaml_file-414"><span class="linenos">414</span></a><span class="sd">  :type file_name: str</span>
</span><span id="parse_yaml_file-415"><a href="#parse_yaml_file-415"><span class="linenos">415</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="parse_yaml_file-416"><a href="#parse_yaml_file-416"><span class="linenos">416</span></a>  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="parse_yaml_file-417"><a href="#parse_yaml_file-417"><span class="linenos">417</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">SafeLoader</span><span class="p">)</span>
</span><span id="parse_yaml_file-418"><a href="#parse_yaml_file-418"><span class="linenos">418</span></a>    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Parse the provided YAML file to get the job configuration</p>

<p>:param file_name: The path to the YAML configuration file
:type file_name: str</p>
</div>


                </section>
                <section id="main">
                            <input id="main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">main</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">argv</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="main-421"><a href="#main-421"><span class="linenos">421</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
</span><span id="main-422"><a href="#main-422"><span class="linenos">422</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="main-423"><a href="#main-423"><span class="linenos">423</span></a><span class="sd">  This is where the Job and Pubsub objects are created and used.</span>
</span><span id="main-424"><a href="#main-424"><span class="linenos">424</span></a>
</span><span id="main-425"><a href="#main-425"><span class="linenos">425</span></a><span class="sd">  :param argv: Standard commandline arguments</span>
</span><span id="main-426"><a href="#main-426"><span class="linenos">426</span></a><span class="sd">  :type argv: _type_</span>
</span><span id="main-427"><a href="#main-427"><span class="linenos">427</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="main-428"><a href="#main-428"><span class="linenos">428</span></a>
</span><span id="main-429"><a href="#main-429"><span class="linenos">429</span></a>  <span class="n">config</span> <span class="o">=</span> <span class="n">parse_yaml_file</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">config_file</span><span class="p">)</span>
</span><span id="main-430"><a href="#main-430"><span class="linenos">430</span></a>
</span><span id="main-431"><a href="#main-431"><span class="linenos">431</span></a>
</span><span id="main-432"><a href="#main-432"><span class="linenos">432</span></a>  <span class="n">jobid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;job_prefix&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
</span><span id="main-433"><a href="#main-433"><span class="linenos">433</span></a>  <span class="n">client</span> <span class="o">=</span> <span class="n">batch_v1</span><span class="o">.</span><span class="n">BatchServiceClient</span><span class="p">()</span>
</span><span id="main-434"><a href="#main-434"><span class="linenos">434</span></a>
</span><span id="main-435"><a href="#main-435"><span class="linenos">435</span></a>  <span class="n">jobs</span> <span class="o">=</span> <span class="n">Jobs</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="main-436"><a href="#main-436"><span class="linenos">436</span></a>  <span class="c1"># This does not create the job yet</span>
</span><span id="main-437"><a href="#main-437"><span class="linenos">437</span></a>  <span class="n">create_request</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">_create_job_request</span><span class="p">()</span>
</span><span id="main-438"><a href="#main-438"><span class="linenos">438</span></a>
</span><span id="main-439"><a href="#main-439"><span class="linenos">439</span></a>  <span class="k">if</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">delete_job</span><span class="p">):</span>
</span><span id="main-440"><a href="#main-440"><span class="linenos">440</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting job&quot;</span><span class="p">)</span>
</span><span id="main-441"><a href="#main-441"><span class="linenos">441</span></a>    <span class="n">deleted_job</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">delete_job</span><span class="p">)</span>
</span><span id="main-442"><a href="#main-442"><span class="linenos">442</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">deleted_job</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
</span><span id="main-443"><a href="#main-443"><span class="linenos">443</span></a>
</span><span id="main-444"><a href="#main-444"><span class="linenos">444</span></a>    <span class="n">exit</span><span class="p">()</span>
</span><span id="main-445"><a href="#main-445"><span class="linenos">445</span></a>
</span><span id="main-446"><a href="#main-446"><span class="linenos">446</span></a>    
</span><span id="main-447"><a href="#main-447"><span class="linenos">447</span></a>  <span class="k">if</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">):</span>
</span><span id="main-448"><a href="#main-448"><span class="linenos">448</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Listing jobs&quot;</span><span class="p">)</span>
</span><span id="main-449"><a href="#main-449"><span class="linenos">449</span></a>    <span class="n">jobs</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">()</span>
</span><span id="main-450"><a href="#main-450"><span class="linenos">450</span></a>
</span><span id="main-451"><a href="#main-451"><span class="linenos">451</span></a>    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
</span><span id="main-452"><a href="#main-452"><span class="linenos">452</span></a>      <span class="nb">print</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span id="main-453"><a href="#main-453"><span class="linenos">453</span></a>
</span><span id="main-454"><a href="#main-454"><span class="linenos">454</span></a>    <span class="n">exit</span><span class="p">()</span>
</span><span id="main-455"><a href="#main-455"><span class="linenos">455</span></a>
</span><span id="main-456"><a href="#main-456"><span class="linenos">456</span></a>  <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="main-457"><a href="#main-457"><span class="linenos">457</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="main-458"><a href="#main-458"><span class="linenos">458</span></a>
</span><span id="main-459"><a href="#main-459"><span class="linenos">459</span></a>    
</span><span id="main-460"><a href="#main-460"><span class="linenos">460</span></a>    <span class="c1"># If pubsub queue is required </span>
</span><span id="main-461"><a href="#main-461"><span class="linenos">461</span></a>  <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">pubsub</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="main-462"><a href="#main-462"><span class="linenos">462</span></a>    <span class="n">pubsub</span> <span class="o">=</span> <span class="n">PubSub</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="main-463"><a href="#main-463"><span class="linenos">463</span></a>
</span><span id="main-464"><a href="#main-464"><span class="linenos">464</span></a>    <span class="c1"># If there is a previous queue to read from:</span>
</span><span id="main-465"><a href="#main-465"><span class="linenos">465</span></a>    <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">previous_job_id</span><span class="p">:</span>
</span><span id="main-466"><a href="#main-466"><span class="linenos">466</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">previous_job_id</span><span class="o">=</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">previous_job_id</span><span class="p">)</span>
</span><span id="main-467"><a href="#main-467"><span class="linenos">467</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="main-468"><a href="#main-468"><span class="linenos">468</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">create_topic</span><span class="p">()</span>
</span><span id="main-469"><a href="#main-469"><span class="linenos">469</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">()</span>
</span><span id="main-470"><a href="#main-470"><span class="linenos">470</span></a>      <span class="n">pubsub</span><span class="o">.</span><span class="n">publish_fifo_ids</span><span class="p">()</span>
</span><span id="main-471"><a href="#main-471"><span class="linenos">471</span></a>
</span><span id="main-472"><a href="#main-472"><span class="linenos">472</span></a>  <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">create_job</span><span class="p">:</span>
</span><span id="main-473"><a href="#main-473"><span class="linenos">473</span></a>    <span class="c1"># Create the job</span>
</span><span id="main-474"><a href="#main-474"><span class="linenos">474</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">create_job</span><span class="p">(</span><span class="n">create_request</span><span class="p">))</span>
</span><span id="main-475"><a href="#main-475"><span class="linenos">475</span></a>  <span class="k">else</span><span class="p">:</span>
</span><span id="main-476"><a href="#main-476"><span class="linenos">476</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">create_request</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This is where the Job and Pubsub objects are created and used.</p>

<p>:param argv: Standard commandline arguments
:type argv: _type_</p>
</div>


                </section>
    </main>
</body>
</html>